<!DOCTYPE html>
<html lang="en-us" 
      xmlns:og="http://ogp.me/ns#" 
      xmlns:fb="https://www.facebook.com/2008/fbml">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.2.0 for Hugo" />
  

  

  
  
  
  
  
  

  

  
  
  
    
  
  <meta name="description" content="In the example guide for generating random numbers, we explored how to use a bunch of different statistical distributions to create variables that had reasonable values. However, each of the columns that we generated there were completely independent of each other." />

  
  <link rel="alternate" hreflang="en-us" href="/example/synthetic-data/" />

  







  




  
  
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    <meta name="theme-color" content="#5271FF" />
  

  
  
    
    <script src="/js/mathjax-config.js"></script>
  

  
  
  
  
    
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha256-FMvZuGapsJLjouA6k7Eo2lusoAX9i0ShlWFG6qt7SLc=" crossorigin="anonymous">

    
    

    
    
    
      
    
    

    
    
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" integrity="" crossorigin="anonymous" async></script>
      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
    
      
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Sans+Condensed:400,400i,700,700i%7CBarlow:ital,wght@0,400;0,700;1,400;1,700&display=swap">
      
    
  

  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.563f345701788434b4fee407179620aa.css" />

  



  

  

  




  
  
  

  

  
    <link rel="manifest" href="/index.webmanifest" />
  

  <link rel="icon" type="image/png" href="/media/icon_hua2ec155b4296a9c9791d015323e16eb5_11927_32x32_fill_lanczos_center_2.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hua2ec155b4296a9c9791d015323e16eb5_11927_180x180_fill_lanczos_center_2.png" />

  <link rel="canonical" href="/example/synthetic-data/" />

  
  
  
  
  
  
  
  
    
    
  
  
  <meta property="twitter:card" content="summary" />
  
    <meta property="twitter:site" content="@valentiandrade" />
    <meta property="twitter:creator" content="@valentiandrade" />
  
  <meta property="og:site_name" content="Análisis Estadístico en R" />
  <meta property="og:url" content="/example/synthetic-data/" />
  <meta property="og:title" content="The ultimate guide to generating synthetic data for causal inference | Análisis Estadístico en R" />
  <meta property="og:description" content="In the example guide for generating random numbers, we explored how to use a bunch of different statistical distributions to create variables that had reasonable values. However, each of the columns that we generated there were completely independent of each other." /><meta property="og:image" content="/media/logo_hu02bc8dfe7cae86b2ee03430b67caeaf2_22353_300x300_fit_lanczos_2.png" />
    <meta property="twitter:image" content="/media/logo_hu02bc8dfe7cae86b2ee03430b67caeaf2_22353_300x300_fit_lanczos_2.png" /><meta property="og:locale" content="en-us" />
  
    
      <meta
        property="article:published_time"
        content="2020-10-31T00:00:00&#43;00:00"
      />
    
    <meta property="article:modified_time" content="2020-10-31T00:00:00&#43;00:00">
  

  



  

  

  <link rel="stylesheet" type="text/css" href="/custom-css/print.css" media="print" />

  <link rel="shortcut icon" href="/favicon.ico" />
  <link rel="apple-touch-icon-precomposed" sizes="57x57" href="/img/apple-touch-icon-57x57.png" />
  <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/img/apple-touch-icon-114x114.png" />
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/img/apple-touch-icon-72x72.png" />
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/apple-touch-icon-144x144.png" />
  <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/img/apple-touch-icon-120x120.png" />
  <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/img/apple-touch-icon-152x152.png" />
  <link rel="icon" type="image/png" href="/img/favicon-32x32.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="/img/favicon-16x16.png" sizes="16x16" />
  <meta name="application-name" content="2255: Análisis Estadístico en R" />
  <meta name="msapplication-TileColor" content="#FFFFFF" />
  <meta name="msapplication-TileImage" content="/img/mstile-144x144.png" />


  <title>The ultimate guide to generating synthetic data for causal inference | Análisis Estadístico en R</title>
</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper  ">

  
  
  
  
  
  <script src="/js/wowchemy-init.js"></script>

    




    











  


<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container-xl">

    
    <div class="d-none d-lg-inline-flex">
      <a class="navbar-brand" href="/"><img src="/media/logo_hu02bc8dfe7cae86b2ee03430b67caeaf2_22353_0x70_resize_lanczos_2.png" alt="Análisis Estadístico en R"></a>
    </div>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="Toggle navigation">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
      <a class="navbar-brand" href="/"><img src="/media/logo_hu02bc8dfe7cae86b2ee03430b67caeaf2_22353_0x70_resize_lanczos_2.png" alt="Análisis Estadístico en R"></a>
    </div>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-end" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        
        <li class="nav-item dropdown">
          <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>Organización</span><span class="caret"></span>
          </a>
          <div class="dropdown-menu">
            
              <a class="dropdown-item" href="/schedule/"><span>Planificación</span></a>
            
              <a class="dropdown-item" href="/syllabus/"><span>Syllabus</span></a>
            
          </div>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/content/"><span>Clases</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
        

        <li class="nav-item">
          <a class="nav-link  active" href="/example/"><span>Prácticos</span></a>
        </li>

        
        

        
        <li class="nav-item dropdown">
          <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>Tareas <i class="fab fa-github"></i></span><span class="caret"></span>
          </a>
          <div class="dropdown-menu">
            
              <a class="dropdown-item" href="/assignment/"><span>Tareas</span></a>
            
              <a class="dropdown-item" href="https://classroom.github.com/classrooms/86887318-learn-r-uah-2021"><span>Github Classroom<i class="fab fa-github"></i></span></a>
            
          </div>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/resource/"><span>Recursos</span></a>
        </li>

        
        

        

        
        
        
          
            
          
        

        

        
        
        
        

        
          
            
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="https://join.slack.com/t/learn-r-uah/shared_invite/zt-sh9uysuu-IzEG8~u5k2YYGWgpAFTRFA" target="_blank" rel="noopener"><span><i class="fab fa-slack"></i></span></a>
        </li>

        
        

        

        
        
        
          
            
          
        

        

        
        
        
        

        
          
            
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="https://rstudio.cloud/" target="_blank" rel="noopener"><span><i class="fab fa-r-project"></i></span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

      
      

      
      

      
      

      
      

    </ul>

  </div>
</nav>



    

<div class="container-fluid docs">
    <div class="row flex-xl-nowrap">
        <div class="col-12 col-md-3 col-xl-2 docs-sidebar">
            





  
    
  




<form class="docs-search d-flex align-items-center">
  <button class="btn docs-toggle d-md-none p-0 mr-3" type="button" data-toggle="collapse" data-target="#docs-nav" aria-controls="docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    <span><i class="fas fa-bars"></i></span>
  </button>

  
</form>

<nav class="collapse docs-links" id="docs-nav">
  

  
  
  
    
  

  
  <div class="docs-toc-item">
    <a class="docs-toc-link" >Información general</a>

  </div>
  
  <div class="docs-toc-item">
    <a class="docs-toc-link" >Datos</a>

  </div>
  
  <div class="docs-toc-item">
    <a class="docs-toc-link" >Ejemplos</a>

  </div>
  
  <div class="docs-toc-item">
    <a class="docs-toc-link" href="/example/rstudio-tidyverse/">Examples</a>
    <ul class="nav docs-sidenav">
      
      <li >
        <a href="/example/rstudio-tidyverse/">R, RStudio, and the tidyverse</a>
      </li>

      
      <li >
        <a href="/example/regression/">Regression</a>
      </li>

      
      <li >
        <a href="/example/dags/">DAGs</a>
      </li>

      
      <li >
        <a href="/example/po-ate-cate/">Potential outcomes, ATEs, and CATEs</a>
      </li>

      
      <li >
        <a href="/example/rcts/">RCTs</a>
      </li>

      
      <li >
        <a href="/example/matching-ipw/">Matching and IPW</a>
      </li>

      
      <li >
        <a href="/example/diff-in-diff/">Diff-in-diff</a>
      </li>

      
      <li >
        <a href="/example/rdd/">Regression discontinuity</a>
      </li>

      
      <li >
        <a href="/example/iv/">Instrumental variables</a>
      </li>

      
      <li >
        <a href="/example/cace/">ITT and CACE</a>
      </li>

      
      <li >
        <a href="/example/rdd-fuzzy/">Fuzzy regression discontinuity</a>
      </li>

      
    </ul>
    

  </div>
  
  <div class="docs-toc-item">
    <a class="docs-toc-link" href="/example/">Overview</a>
    <ul class="nav docs-sidenav">
      
      <li >
        <a href="/example/">Code examples</a>
      </li>

      
    </ul>
    

  </div>
  
  <div class="docs-toc-item">
    <a class="docs-toc-link" href="/example/random-numbers/">Simulated data</a>
    <ul class="nav docs-sidenav">
      
      <li >
        <a href="/example/random-numbers/">Random numbers</a>
      </li>

      
      <li class="active">
        <a href="/example/synthetic-data/">Synthetic data</a>
      </li>

      
    </ul>
    

  </div>
  
  
</nav>

        </div>

        
        <div class="d-none d-xl-block col-xl-2 docs-toc">
            <ul class="nav toc-top">
                <li><a href="#" id="back_to_top" class="docs-toc-title">Contents</a></li>
            </ul>

            <nav id="TableOfContents">
  <ul>
    <li><a href="#basic-example">Basic example</a>
      <ul>
        <li><a href="#relationships-and-regression">Relationships and regression</a></li>
        <li><a href="#explanatory-variables-linked-to-outcome-no-connection-between-explanatory-variables">Explanatory variables linked to outcome; no connection between explanatory variables</a></li>
        <li><a href="#explanatory-variables-linked-to-outcome-connection-between-explanatory-variables">Explanatory variables linked to outcome; connection between explanatory variables</a></li>
        <li><a href="#adding-extra-noise">Adding extra noise</a></li>
      </ul>
    </li>
    <li><a href="#visualizing-variables-and-relationships">Visualizing variables and relationships</a>
      <ul>
        <li><a href="#visualizing-one-variable">Visualizing one variable</a></li>
        <li><a href="#visualizing-two-continuous-variables">Visualizing two continuous variables</a></li>
        <li><a href="#visualizing-a-binary-variable-and-a-continuous-variable">Visualizing a binary variable and a continuous variable</a></li>
      </ul>
    </li>
    <li><a href="#specific-examples">Specific examples</a>
      <ul>
        <li><a href="#tldr-the-general-process">tl;dr: The general process</a></li>
        <li><a href="#creating-an-effect-in-an-observational-dag">Creating an effect in an observational DAG</a></li>
        <li><a href="#brief-pep-talk-intermission">Brief pep talk intermission</a></li>
        <li><a href="#creating-an-effect-for-rcts">Creating an effect for RCTs</a></li>
        <li><a href="#creating-an-effect-for-diff-in-diff">Creating an effect for diff-in-diff</a></li>
        <li><a href="#creating-an-effect-for-regression-discontinuity">Creating an effect for regression discontinuity</a></li>
        <li><a href="#creating-an-effect-for-instrumental-variables">Creating an effect for instrumental variables</a></li>
      </ul>
    </li>
    <li><a href="#use-synthetic-data-packages">Use synthetic data packages</a>
      <ul>
        <li><a href="#fabricatr">fabricatr</a></li>
        <li><a href="#wakefield">wakefield</a></li>
        <li><a href="#faux">faux</a></li>
      </ul>
    </li>
  </ul>
</nav>

 
        </div>
        

        <main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 docs-content" role="main">

            <article class="article">

                <div class="docs-article-container">
                    <h1>The ultimate guide to generating synthetic data for causal inference</h1>

                    

                    

                    

                    <div class="article-style">
                        <p>In the <a href="/example/random-numbers/">example guide for generating random numbers</a>, we explored how to use a bunch of different statistical distributions to create variables that had reasonable values. However, each of the columns that we generated there were completely independent of each other. In the final example, we made some data with columns like age, education, and income, but none of those were related, though in real life they would be.</p>
<p>Generating random variables is fairly easy: choose some sort of distributional shape, set parameters like a mean and standard deviation, and let randomness take over. Forcing variables to be related is a little trickier and involves a little math. But don&rsquo;t worry! That math is all just regression stuff!</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">library</span>(tidyverse)
<span style="color:#a6e22e">library</span>(broom)
<span style="color:#a6e22e">library</span>(patchwork)
<span style="color:#a6e22e">library</span>(scales)
<span style="color:#a6e22e">library</span>(ggdag)
</code></pre></div><h2 id="basic-example">Basic example</h2>
<h3 id="relationships-and-regression">Relationships and regression</h3>
<p>Let&rsquo;s pretend we want to predict someone&rsquo;s happiness on a 10-point scale based on the number of cookies they&rsquo;ve eaten and whether or not their favorite color is blue.</p>
<p>$$
\text{Happiness} = \beta_0 + \beta_1 \text{Cookies eaten} + \beta_2 \text{Favorite color is blue} + \varepsilon
$$</p>
<p>We can generate a fake dataset with columns for happiness (Beta distribution clustered around 7ish), cookies (Poisson distribution), and favorite color (binomial distribution for blue/not blue):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">set.seed</span>(<span style="color:#ae81ff">1234</span>)

n_people <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1000</span>
happiness_simple <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">tibble</span>(
  id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>n_people,
  happiness <span style="color:#f92672">=</span> <span style="color:#a6e22e">rbeta</span>(n_people, shape1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>, shape2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>),
  cookies <span style="color:#f92672">=</span> <span style="color:#a6e22e">rpois</span>(n_people, lambda <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>),
  color_blue <span style="color:#f92672">=</span> <span style="color:#a6e22e">sample</span>(<span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;Blue&#34;</span>, <span style="color:#e6db74">&#34;Not blue&#34;</span>), n_people, replace <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>)
) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Adjust some of the columns</span>
  <span style="color:#a6e22e">mutate</span>(happiness <span style="color:#f92672">=</span> <span style="color:#a6e22e">round</span>(happiness <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">1</span>),
         cookies <span style="color:#f92672">=</span> cookies <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>,
         color_blue <span style="color:#f92672">=</span> <span style="color:#a6e22e">fct_relevel</span>(<span style="color:#a6e22e">factor</span>(color_blue), <span style="color:#e6db74">&#34;Not blue&#34;</span>))

<span style="color:#a6e22e">head</span>(happiness_simple)
<span style="color:#75715e">## # A tibble: 6 x 4</span>
<span style="color:#75715e">##      id happiness cookies color_blue</span>
<span style="color:#75715e">##   &lt;int&gt;     &lt;dbl&gt;   &lt;dbl&gt; &lt;fct&gt;     </span>
<span style="color:#75715e">## 1     1       8.7       2 Blue      </span>
<span style="color:#75715e">## 2     2       6.5       2 Not blue  </span>
<span style="color:#75715e">## 3     3       4.8       2 Blue      </span>
<span style="color:#75715e">## 4     4       9.6       3 Not blue  </span>
<span style="color:#75715e">## 5     5       6.2       1 Not blue  </span>
<span style="color:#75715e">## 6     6       6.1       2 Blue</span>
</code></pre></div><p>We have a neat dataset now, so let&rsquo;s run a regression. Is eating more cookies or liking blue associated with greater happiness?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">model_happiness1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(happiness <span style="color:#f92672">~</span> cookies <span style="color:#f92672">+</span> color_blue, data <span style="color:#f92672">=</span> happiness_simple)
<span style="color:#a6e22e">tidy</span>(model_happiness1)
<span style="color:#75715e">## # A tibble: 3 x 5</span>
<span style="color:#75715e">##   term           estimate std.error statistic p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;             &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)     7.06       0.105     67.0     0    </span>
<span style="color:#75715e">## 2 cookies        -0.00884    0.0419    -0.211   0.833</span>
<span style="color:#75715e">## 3 color_blueBlue -0.0202     0.0861    -0.235   0.815</span>
</code></pre></div><p>Not really. The coefficients for both <code>cookies</code> and <code>color_blueBlue</code> are basically 0 and not statistically significant. That makes sense since the three columns are completely independent of each other. If there were any significant effects, that&rsquo;d be strange and solely because of random chance.</p>
<p><strong>For the sake of your final project, you can just leave all the columns completely independent of each other if you want.</strong> None of your results will be significant and you won&rsquo;t see any effects anywhere, but you can still build models, run all the pre-model diagnostics, and create graphs and tables based on this data.</p>
<p><em><strong>HOWEVER</strong></em>, it will be far more useful to you if you generate relationships. The whole goal of this class is to find causal effects in observational, non-experimental data. If you can generate synthetic non-experimental data and bake in a known causal effect, you can know if your different methods for recovering that effect are working.</p>
<p>So how do we bake in correlations and causal effects?</p>
<h3 id="explanatory-variables-linked-to-outcome-no-connection-between-explanatory-variables">Explanatory variables linked to outcome; no connection between explanatory variables</h3>
<p>To help with the intuition of how to link these columns, think about the model we&rsquo;re building:</p>
<p>$$
\text{Happiness} = \beta_0 + \beta_1 \text{Cookies eaten} + \beta_2 \text{Favorite color is blue} + \varepsilon
$$</p>
<p>This model provides estimates for all those betas. Throughout the semester, we&rsquo;ve used the analogy of sliders and switches to describe regression coefficients. Here we have both:</p>
<ul>
<li><code>\(\beta_0\)</code>: The average baseline happiness.</li>
<li><code>\(\beta_1\)</code>: The additional change in happiness that comes from eating one cookie. This is a <em>slider</em>: move cookies up by one and happiness changes by <code>\(\beta_1\)</code>.</li>
<li><code>\(\beta_2\)</code>: The change in happiness that comes from having your favorite color be blue. This is a <em>switch</em>: turn on &ldquo;blue&rdquo; for someone and their happiness changes by <code>\(\beta_2\)</code>.</li>
</ul>
<p>We can invent our own coefficients and use some math to build them into the dataset. Let&rsquo;s use these numbers as our targets:</p>
<ul>
<li><code>\(\beta_0\)</code>: Average happiness is 7</li>
<li><code>\(\beta_1\)</code>: Eating one more cookie boosts happiness by 0.25 points</li>
<li><code>\(\beta_2\)</code>: People who like blue have 0.75 higher happiness</li>
</ul>
<p>When generating the data, we can&rsquo;t just use <code>rbeta()</code> by itself to generate happiness, since happiness depends on both cookies and favorite color (that&rsquo;s why we call it a dependent variable). To build in this effect, we can add a new column that uses math and modifies the underlying <code>rbeta()</code>-based happiness score:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">happiness_with_effect <span style="color:#f92672">&lt;-</span> happiness_simple <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Turn the categorical favorite color column into TRUE/FALSE so we can do math with it</span>
  <span style="color:#a6e22e">mutate</span>(color_blue_binary <span style="color:#f92672">=</span> <span style="color:#a6e22e">ifelse</span>(color_blue <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Blue&#34;</span>, <span style="color:#66d9ef">TRUE</span>, <span style="color:#66d9ef">FALSE</span>)) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Make a new happiness column that uses coefficients for cookies and favorite color</span>
  <span style="color:#a6e22e">mutate</span>(happiness_modified <span style="color:#f92672">=</span> happiness <span style="color:#f92672">+</span> (<span style="color:#ae81ff">0.25</span> <span style="color:#f92672">*</span> cookies) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">0.75</span> <span style="color:#f92672">*</span> color_blue_binary))
<span style="color:#a6e22e">head</span>(happiness_with_effect)
<span style="color:#75715e">## # A tibble: 6 x 6</span>
<span style="color:#75715e">##      id happiness cookies color_blue color_blue_binary happiness_modified</span>
<span style="color:#75715e">##   &lt;int&gt;     &lt;dbl&gt;   &lt;dbl&gt; &lt;fct&gt;      &lt;lgl&gt;                          &lt;dbl&gt;</span>
<span style="color:#75715e">## 1     1       8.7       2 Blue       TRUE                            9.95</span>
<span style="color:#75715e">## 2     2       6.5       2 Not blue   FALSE                           7   </span>
<span style="color:#75715e">## 3     3       4.8       2 Blue       TRUE                            6.05</span>
<span style="color:#75715e">## 4     4       9.6       3 Not blue   FALSE                          10.4 </span>
<span style="color:#75715e">## 5     5       6.2       1 Not blue   FALSE                           6.45</span>
<span style="color:#75715e">## 6     6       6.1       2 Blue       TRUE                            7.35</span>
</code></pre></div><p>Now that we have a new <code>happiness_modified</code> column we can run a model using it as the outcome:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">model_happiness2 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(happiness_modified <span style="color:#f92672">~</span> cookies <span style="color:#f92672">+</span> color_blue, data <span style="color:#f92672">=</span> happiness_with_effect)
<span style="color:#a6e22e">tidy</span>(model_happiness2)
<span style="color:#75715e">## # A tibble: 3 x 5</span>
<span style="color:#75715e">##   term           estimate std.error statistic  p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;             &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)       7.06     0.105      67.0  0.      </span>
<span style="color:#75715e">## 2 cookies           0.241    0.0419      5.76 1.13e- 8</span>
<span style="color:#75715e">## 3 color_blueBlue    0.730    0.0861      8.48 8.25e-17</span>
</code></pre></div><p>Whoa! Look at those coefficients! They&rsquo;re exactly what we tried to build in! The baseline happiness (intercept) is ≈7, eating one cookie is associated with a ≈0.25 increase in happiness, and liking blue is associated with a ≈0.75 increase in happiness.</p>
<p>However, we originally said that happiness was a 0-10 point scale. After boosting it with extra happiness for cookies and liking blue, there are some people who score higher than 10:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Original scale</span>
<span style="color:#a6e22e">ggplot</span>(happiness_with_effect, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> happiness)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_histogram</span>(binwidth <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;white&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_x_continuous</span>(breaks <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">11</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">coord_cartesian</span>(xlim <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">11</span>))
</code></pre></div><p><img src="/example/synthetic-data_files/figure-html/happiness-dist-normal-1.png" width="75%" style="display: block; margin: auto;" /></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Scaled up</span>
<span style="color:#a6e22e">ggplot</span>(happiness_with_effect, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> happiness_modified)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_histogram</span>(binwidth <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;white&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_x_continuous</span>(breaks <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">11</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">coord_cartesian</span>(xlim <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">11</span>))
</code></pre></div><p><img src="/example/synthetic-data_files/figure-html/happiness-dist-scaled-up-1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>To fix that, we can use the <code>rescale()</code> function from the <strong>scales</strong> package to force the new <code>happiness_modified</code> variable to fit back in its original range:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">happiness_with_effect <span style="color:#f92672">&lt;-</span> happiness_with_effect <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">mutate</span>(happiness_rescaled <span style="color:#f92672">=</span> <span style="color:#a6e22e">rescale</span>(happiness_modified, to <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">10</span>)))

<span style="color:#a6e22e">ggplot</span>(happiness_with_effect, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> happiness_rescaled)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_histogram</span>(binwidth <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;white&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_x_continuous</span>(breaks <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">11</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">coord_cartesian</span>(xlim <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">11</span>))
</code></pre></div><p><img src="/example/synthetic-data_files/figure-html/happiness-scaled-down-1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Everything is back in the 3–10 range now. However, the rescaling also rescaled our built-in effects. Look what happens if we use the <code>happiness_rescaled</code> in the model:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">model_happiness3 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(happiness_rescaled <span style="color:#f92672">~</span> cookies <span style="color:#f92672">+</span> color_blue, data <span style="color:#f92672">=</span> happiness_with_effect)
<span style="color:#a6e22e">tidy</span>(model_happiness3)
<span style="color:#75715e">## # A tibble: 3 x 5</span>
<span style="color:#75715e">##   term           estimate std.error statistic  p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;             &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)       6.34     0.0910     69.6  0.      </span>
<span style="color:#75715e">## 2 cookies           0.208    0.0362      5.76 1.13e- 8</span>
<span style="color:#75715e">## 3 color_blueBlue    0.631    0.0744      8.48 8.25e-17</span>
</code></pre></div><p>Now the baseline happiness is 6.3, the cookies effect is 0.2, and the blue effect is 0.63. These effects shrunk because we shrunk the data back down to have a maximum of 10.</p>
<p>There are probably fancy mathy ways to rescale data <em>and</em> keep the coefficients the same size, but rather than figure that out (who even wants to do that?!), my strategy is just to play with numbers until the results look good. Instead of using a 0.25 cookie effect and 0.75 blue effect, I make those effects bigger so that the rescaled version is roughly what I really want. There&rsquo;s no systematic way to do this—I ran this chunk below a bunch of times until the numbers worked.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">set.seed</span>(<span style="color:#ae81ff">1234</span>)

n_people <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1000</span>
happiness_real_effect <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">tibble</span>(
  id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>n_people,
  happiness_baseline <span style="color:#f92672">=</span> <span style="color:#a6e22e">rbeta</span>(n_people, shape1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>, shape2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>),
  cookies <span style="color:#f92672">=</span> <span style="color:#a6e22e">rpois</span>(n_people, lambda <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>),
  color_blue <span style="color:#f92672">=</span> <span style="color:#a6e22e">sample</span>(<span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;Blue&#34;</span>, <span style="color:#e6db74">&#34;Not blue&#34;</span>), n_people, replace <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>)
) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Adjust some of the columns</span>
  <span style="color:#a6e22e">mutate</span>(happiness_baseline <span style="color:#f92672">=</span> <span style="color:#a6e22e">round</span>(happiness_baseline <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">1</span>),
         cookies <span style="color:#f92672">=</span> cookies <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>,
         color_blue <span style="color:#f92672">=</span> <span style="color:#a6e22e">fct_relevel</span>(<span style="color:#a6e22e">factor</span>(color_blue), <span style="color:#e6db74">&#34;Not blue&#34;</span>)) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Turn the categorical favorite color column into TRUE/FALSE so we can do math with it</span>
  <span style="color:#a6e22e">mutate</span>(color_blue_binary <span style="color:#f92672">=</span> <span style="color:#a6e22e">ifelse</span>(color_blue <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Blue&#34;</span>, <span style="color:#66d9ef">TRUE</span>, <span style="color:#66d9ef">FALSE</span>)) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Make a new happiness column that uses coefficients for cookies and favorite color</span>
  <span style="color:#a6e22e">mutate</span>(happiness_effect <span style="color:#f92672">=</span> happiness_baseline <span style="color:#f92672">+</span>
           (<span style="color:#ae81ff">0.31</span> <span style="color:#f92672">*</span> cookies) <span style="color:#f92672">+</span>  <span style="color:#75715e"># Cookie effect</span>
           (<span style="color:#ae81ff">0.91</span> <span style="color:#f92672">*</span> color_blue_binary)) <span style="color:#f92672">%&gt;%</span>  <span style="color:#75715e"># Blue effect</span>
  <span style="color:#75715e"># Rescale to 3-10, since that&#39;s what the original happiness column looked like</span>
  <span style="color:#a6e22e">mutate</span>(happiness <span style="color:#f92672">=</span> <span style="color:#a6e22e">rescale</span>(happiness_effect, to <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">10</span>)))

model_does_this_work_yet <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(happiness <span style="color:#f92672">~</span> cookies <span style="color:#f92672">+</span> color_blue, data <span style="color:#f92672">=</span> happiness_real_effect)
<span style="color:#a6e22e">tidy</span>(model_does_this_work_yet)
<span style="color:#75715e">## # A tibble: 3 x 5</span>
<span style="color:#75715e">##   term           estimate std.error statistic  p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;             &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)       6.15     0.0886     69.4  0.      </span>
<span style="color:#75715e">## 2 cookies           0.253    0.0352      7.19 1.25e-12</span>
<span style="color:#75715e">## 3 color_blueBlue    0.749    0.0724     10.3  7.44e-24</span>
</code></pre></div><p>There&rsquo;s nothing magical about the 0.31 and 0.91 numbers I used here; I just kept changing those to different things until the regression coefficients ended up at ≈0.25 and ≈0.75. Also, I gave up on trying to make the baseline happiness 7. It&rsquo;s possible to do—you&rsquo;d just need to also shift the underlying Beta distribution up (like <code>shape1 = 9, shape2 = 2</code> or something). But then you&rsquo;d also need to change the coefficients more. You&rsquo;ll end up with 3 moving parts and it can get complicated, so I don&rsquo;t worry too much about it, since what we care about the most here is the effect of cookies and favorite color, not baseline levels of happiness.</p>
<p>Phew. We successfully connected cookies and favorite color to happiness and we have effects that are measurable with regression! One last thing that I would do is get rid of some of the intermediate columns like <code>color_blue_binary</code> or <code>happiness_effect</code>—we only used those for the behind-the-scenes math of creating the effect. Here&rsquo;s our final synthetic dataset:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">happiness <span style="color:#f92672">&lt;-</span> happiness_real_effect <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">select</span>(id, happiness, cookies, color_blue)
<span style="color:#a6e22e">head</span>(happiness)
<span style="color:#75715e">## # A tibble: 6 x 4</span>
<span style="color:#75715e">##      id happiness cookies color_blue</span>
<span style="color:#75715e">##   &lt;int&gt;     &lt;dbl&gt;   &lt;dbl&gt; &lt;fct&gt;     </span>
<span style="color:#75715e">## 1     1      8.81       2 Blue      </span>
<span style="color:#75715e">## 2     2      6.20       2 Not blue  </span>
<span style="color:#75715e">## 3     3      5.53       2 Blue      </span>
<span style="color:#75715e">## 4     4      9.07       3 Not blue  </span>
<span style="color:#75715e">## 5     5      5.68       1 Not blue  </span>
<span style="color:#75715e">## 6     6      6.63       2 Blue</span>
</code></pre></div><p>We can save that as a CSV file with <code>write_csv()</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">write_csv</span>(happiness, <span style="color:#e6db74">&#34;data/happiness_fake_data.csv&#34;</span>)
</code></pre></div><h3 id="explanatory-variables-linked-to-outcome-connection-between-explanatory-variables">Explanatory variables linked to outcome; connection between explanatory variables</h3>
<p>In that cookie example, we assumed that both cookie consumption and favorite color are associated with happiness. We also assumed that cookie consumption and favorite color are <em>not</em> related to each other. But what if they are? What if people who like blue eat more cookies?</p>
<p>We&rsquo;ve already used regression-based math to connect explanatory variables to outcome variables. We can use that same intuition to connect explanatory variables to each other.</p>
<p>The easiest way to think about this is with DAGs. Here&rsquo;s the DAG for the model we just ran:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">happiness_dag1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dagify</span>(hap <span style="color:#f92672">~</span> cook <span style="color:#f92672">+</span> blue,
                         coords <span style="color:#f92672">=</span> <span style="color:#a6e22e">list</span>(x <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(hap <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, cook <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, blue <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>),
                                       y <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(hap <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, cook <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, blue <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>)))

<span style="color:#a6e22e">ggdag</span>(happiness_dag1) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme_dag</span>()
</code></pre></div><p><img src="/example/synthetic-data_files/figure-html/happiness-dag-rct-1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Both cookies and favorite color cause happiness, but there&rsquo;s no link between them. Notice that <code>dagify()</code> uses the same model syntax that <code>lm()</code> does: <code>hap ~ cook + blue</code>. If we think of this just like a regression model, we can pretend that there are coefficients there too: <code>hap ~ 0.25*cook + 0.75*blue</code>. We don&rsquo;t actually include any coefficients in the DAG or anything, but it helps with the intuition.</p>
<p>But what if people who like blue eat more cookies on average? For whatever reason, let&rsquo;s pretend that liking blue causes you to eat 0.5 more cookies, on average. Here&rsquo;s the new DAG:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">happiness_dag2 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dagify</span>(hap <span style="color:#f92672">~</span> cook <span style="color:#f92672">+</span> blue,
                         cook <span style="color:#f92672">~</span> blue,
                         coords <span style="color:#f92672">=</span> <span style="color:#a6e22e">list</span>(x <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(hap <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, cook <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, blue <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>),
                                       y <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(hap <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, cook <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, blue <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>)))

<span style="color:#a6e22e">ggdag</span>(happiness_dag2) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme_dag</span>()
</code></pre></div><p><img src="/example/synthetic-data_files/figure-html/happiness-dag-confounding-1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Now we have two different equations: <code>hap ~ cook + blue</code> and <code>cook ~ blue</code>. Conveniently, these both translate to models, and we know the coefficients we want!</p>
<ul>
<li><code>hap ~ 0.25*cook + 0.75*blue</code>: This is what we built before—cookies boost happiness by 0.25 and liking blue boosts happiness by 0.75</li>
<li><code>cook ~ 0.3*blue</code>: This is what we just proposed—liking blue boosts cookies by 0.5</li>
</ul>
<p>We can follow the same process we did when building the cookie and blue effects into happiness to also build a blue effect into cookies!</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">set.seed</span>(<span style="color:#ae81ff">1234</span>)

n_people <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1000</span>
happiness_cookies_blue <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">tibble</span>(
  id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>n_people,
  happiness_baseline <span style="color:#f92672">=</span> <span style="color:#a6e22e">rbeta</span>(n_people, shape1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>, shape2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>),
  cookies <span style="color:#f92672">=</span> <span style="color:#a6e22e">rpois</span>(n_people, lambda <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>),
  color_blue <span style="color:#f92672">=</span> <span style="color:#a6e22e">sample</span>(<span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;Blue&#34;</span>, <span style="color:#e6db74">&#34;Not blue&#34;</span>), n_people, replace <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>)
) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Adjust some of the columns</span>
  <span style="color:#a6e22e">mutate</span>(happiness_baseline <span style="color:#f92672">=</span> <span style="color:#a6e22e">round</span>(happiness_baseline <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">1</span>),
         cookies <span style="color:#f92672">=</span> cookies <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>,
         color_blue <span style="color:#f92672">=</span> <span style="color:#a6e22e">fct_relevel</span>(<span style="color:#a6e22e">factor</span>(color_blue), <span style="color:#e6db74">&#34;Not blue&#34;</span>)) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Turn the categorical favorite color column into TRUE/FALSE so we can do math with it</span>
  <span style="color:#a6e22e">mutate</span>(color_blue_binary <span style="color:#f92672">=</span> <span style="color:#a6e22e">ifelse</span>(color_blue <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Blue&#34;</span>, <span style="color:#66d9ef">TRUE</span>, <span style="color:#66d9ef">FALSE</span>)) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Make blue have an effect on cookie consumption</span>
  <span style="color:#a6e22e">mutate</span>(cookies <span style="color:#f92672">=</span> cookies <span style="color:#f92672">+</span> (<span style="color:#ae81ff">0.5</span> <span style="color:#f92672">*</span> color_blue_binary)) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Make a new happiness column that uses coefficients for cookies and favorite color</span>
  <span style="color:#a6e22e">mutate</span>(happiness_effect <span style="color:#f92672">=</span> happiness_baseline <span style="color:#f92672">+</span>
           (<span style="color:#ae81ff">0.31</span> <span style="color:#f92672">*</span> cookies) <span style="color:#f92672">+</span>  <span style="color:#75715e"># Cookie effect</span>
           (<span style="color:#ae81ff">0.91</span> <span style="color:#f92672">*</span> color_blue_binary)) <span style="color:#f92672">%&gt;%</span>  <span style="color:#75715e"># Blue effect</span>
  <span style="color:#75715e"># Rescale to 3-10, since that&#39;s what the original happiness column looked like</span>
  <span style="color:#a6e22e">mutate</span>(happiness <span style="color:#f92672">=</span> <span style="color:#a6e22e">rescale</span>(happiness_effect, to <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">10</span>)))
<span style="color:#a6e22e">head</span>(happiness_cookies_blue)
<span style="color:#75715e">## # A tibble: 6 x 7</span>
<span style="color:#75715e">##      id happiness_baseline cookies color_blue color_blue_binary happiness_effect happiness</span>
<span style="color:#75715e">##   &lt;int&gt;              &lt;dbl&gt;   &lt;dbl&gt; &lt;fct&gt;      &lt;lgl&gt;                        &lt;dbl&gt;     &lt;dbl&gt;</span>
<span style="color:#75715e">## 1     1                8.7     2.5 Blue       TRUE                         10.4       8.84</span>
<span style="color:#75715e">## 2     2                6.5     2   Not blue   FALSE                         7.12      6.14</span>
<span style="color:#75715e">## 3     3                4.8     2.5 Blue       TRUE                          6.48      5.61</span>
<span style="color:#75715e">## 4     4                9.6     3   Not blue   FALSE                        10.5       8.96</span>
<span style="color:#75715e">## 5     5                6.2     1   Not blue   FALSE                         6.51      5.63</span>
<span style="color:#75715e">## 6     6                6.1     2.5 Blue       TRUE                          7.78      6.69</span>
</code></pre></div><p>Notice now that people who like blue eat partial cookies, as expected. We can verify that there&rsquo;s a relationship between liking blue and cookies by running a model:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">lm</span>(cookies <span style="color:#f92672">~</span> color_blue, data <span style="color:#f92672">=</span> happiness_cookies_blue) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">tidy</span>()
<span style="color:#75715e">## # A tibble: 2 x 5</span>
<span style="color:#75715e">##   term           estimate std.error statistic   p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;             &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)       2.07     0.0451     45.9  3.51e-248</span>
<span style="color:#75715e">## 2 color_blueBlue    0.460    0.0651      7.07 2.96e- 12</span>
</code></pre></div><p>Yep. Liking blue is associated with 0.46 more cookies on average (it&rsquo;s not quite 0.5, but that&rsquo;s because of randomness).</p>
<p>Now let&rsquo;s do some neat DAG magic. Let&rsquo;s say we&rsquo;re interested in the causal effect of cookies on happiness. We could run a naive model:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">model_happiness_naive <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(happiness <span style="color:#f92672">~</span> cookies, data <span style="color:#f92672">=</span> happiness_cookies_blue)
<span style="color:#a6e22e">tidy</span>(model_happiness_naive)
<span style="color:#75715e">## # A tibble: 2 x 5</span>
<span style="color:#75715e">##   term        estimate std.error statistic  p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)    6.27     0.0894     70.1  0.      </span>
<span style="color:#75715e">## 2 cookies        0.325    0.0354      9.18 2.40e-19</span>
</code></pre></div><p>Based on this, eating a cookie causes you to have 0.325 more happiness points. But that&rsquo;s wrong! Liking the color blue is a confounder and opens a path between cookies and happiness. You can see the confounding both in the DAG (since blue points to both the cookie node and the happiness node) and in the math (liking blue boosts happiness + liking blue boosts cookie consumption, which boosts happiness).</p>
<p>To fix this confounding, we need to statistically adjust for liking blue and close the backdoor path. Ordinarily we&rsquo;d do this with something like <a href="/example/matching-ipw/">matching or inverse probability weighting</a>, but here we can just include liking blue as a control variable (since it&rsquo;s linearly related to both cookies and happiness):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">model_happiness_ate <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(happiness <span style="color:#f92672">~</span> cookies <span style="color:#f92672">+</span> color_blue, data <span style="color:#f92672">=</span> happiness_cookies_blue)
<span style="color:#a6e22e">tidy</span>(model_happiness_ate)
<span style="color:#75715e">## # A tibble: 3 x 5</span>
<span style="color:#75715e">##   term           estimate std.error statistic  p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;             &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)       6.09     0.0870     70.0  0.      </span>
<span style="color:#75715e">## 2 cookies           0.249    0.0346      7.19 1.25e-12</span>
<span style="color:#75715e">## 3 color_blueBlue    0.739    0.0729     10.1  4.70e-23</span>
</code></pre></div><p>After adjusting for backdoor confounding, eating one additional cookie <em>causes</em> a 0.249 point increase in happiness. This is the effect we originally built into the data!</p>
<p>If you wanted, we could rescale the number of cookies just like we rescaled happiness before, since sometimes adding effects to columns changes their reasonable ranges.</p>
<p>Now that we have a good working dataset, we can keep the columns we care about and save it as a CSV file for later use:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">happiness <span style="color:#f92672">&lt;-</span> happiness_cookies_blue <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">select</span>(id, happiness, cookies, color_blue)
<span style="color:#a6e22e">head</span>(happiness)
<span style="color:#75715e">## # A tibble: 6 x 4</span>
<span style="color:#75715e">##      id happiness cookies color_blue</span>
<span style="color:#75715e">##   &lt;int&gt;     &lt;dbl&gt;   &lt;dbl&gt; &lt;fct&gt;     </span>
<span style="color:#75715e">## 1     1      8.84     2.5 Blue      </span>
<span style="color:#75715e">## 2     2      6.14     2   Not blue  </span>
<span style="color:#75715e">## 3     3      5.61     2.5 Blue      </span>
<span style="color:#75715e">## 4     4      8.96     3   Not blue  </span>
<span style="color:#75715e">## 5     5      5.63     1   Not blue  </span>
<span style="color:#75715e">## 6     6      6.69     2.5 Blue</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">write_csv</span>(happiness, <span style="color:#e6db74">&#34;data/happiness_fake_data.csv&#34;</span>)
</code></pre></div><h3 id="adding-extra-noise">Adding extra noise</h3>
<p>We&rsquo;ve got columns that follow specific distributions, and we&rsquo;ve got columns that are statistically related to each other. We can add one more wrinkle to make our fake data even more fun (and even more reflective of real life). We can add some noise.</p>
<p>Right now, the effects we&rsquo;re finding are <em>too</em> perfect. When we used <code>mutate()</code> to add a 0.25 boost in happiness for every cookie people ate, we added <em>exactly</em> 0.25 happiness points. If someone ate 2 cookies, they got 0.5 more happiness; if they ate 5, they got 1.25 more.</p>
<p>What if the cookie effect isn&rsquo;t exactly 0.25, but somewhere <em>around</em> 0.25? For some people it&rsquo;s 0.1, for others it&rsquo;s 0.3, for others it&rsquo;s 0.22. We can use the same ideas we talked about in the <a href="/example/random-numbers/">random numbers example</a> to generate a <em>distribution</em> of an effect. For instance, let&rsquo;s say that the average cookie effect is 0.25, but it can vary somewhat with a standard deviation of 0.15:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">temp_data <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">tibble</span>(x <span style="color:#f92672">=</span> <span style="color:#a6e22e">rnorm</span>(<span style="color:#ae81ff">10000</span>, mean <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.25</span>, sd <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.15</span>))

<span style="color:#a6e22e">ggplot</span>(temp_data, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> x)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_histogram</span>(binwidth <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.05</span>, boundary <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;white&#34;</span>)
</code></pre></div><p><img src="/example/synthetic-data_files/figure-html/random-cookie-effect-1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Sometimes it can go as low as −0.25; sometimes it can go as high as 0.75; normally it&rsquo;s around 0.25.</p>
<p>Nothing in the model explains why it&rsquo;s higher or lower for some people—it&rsquo;s just random noise. Remember that the model accounts for that! This random variation is what the <code>\(\varepsilon\)</code> is for in this model equation:</p>
<p>$$
\text{Happiness} = \beta_0 + \beta_1 \text{Cookies eaten} + \beta_2 \text{Favorite color is blue} + \varepsilon
$$</p>
<p>We can build that uncertainty into the fake column! Instead of using <code>0.31 * cookies</code> when generating <code>happiness</code> (which is technically 0.25, but shifted up to account for rescaling happiness back down after), we&rsquo;ll make a column for the cookie effect and then multiply <em>that</em> by the number of cookies.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">set.seed</span>(<span style="color:#ae81ff">1234</span>)

n_people <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1000</span>
happiness_cookies_noisier <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">tibble</span>(
  id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>n_people,
  happiness_baseline <span style="color:#f92672">=</span> <span style="color:#a6e22e">rbeta</span>(n_people, shape1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>, shape2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>),
  cookies <span style="color:#f92672">=</span> <span style="color:#a6e22e">rpois</span>(n_people, lambda <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>),
  cookie_effect <span style="color:#f92672">=</span> <span style="color:#a6e22e">rnorm</span>(n_people, mean <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.31</span>, sd <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.2</span>),
  color_blue <span style="color:#f92672">=</span> <span style="color:#a6e22e">sample</span>(<span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;Blue&#34;</span>, <span style="color:#e6db74">&#34;Not blue&#34;</span>), n_people, replace <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>)
) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Adjust some of the columns</span>
  <span style="color:#a6e22e">mutate</span>(happiness_baseline <span style="color:#f92672">=</span> <span style="color:#a6e22e">round</span>(happiness_baseline <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">1</span>),
         cookies <span style="color:#f92672">=</span> cookies <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>,
         color_blue <span style="color:#f92672">=</span> <span style="color:#a6e22e">fct_relevel</span>(<span style="color:#a6e22e">factor</span>(color_blue), <span style="color:#e6db74">&#34;Not blue&#34;</span>)) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Turn the categorical favorite color column into TRUE/FALSE so we can do math with it</span>
  <span style="color:#a6e22e">mutate</span>(color_blue_binary <span style="color:#f92672">=</span> <span style="color:#a6e22e">ifelse</span>(color_blue <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Blue&#34;</span>, <span style="color:#66d9ef">TRUE</span>, <span style="color:#66d9ef">FALSE</span>)) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Make blue have an effect on cookie consumption</span>
  <span style="color:#a6e22e">mutate</span>(cookies <span style="color:#f92672">=</span> cookies <span style="color:#f92672">+</span> (<span style="color:#ae81ff">0.5</span> <span style="color:#f92672">*</span> color_blue_binary)) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Make a new happiness column that uses coefficients for cookies and favorite</span>
  <span style="color:#75715e"># color. Importantly, instead of using 0.31 * cookies, we&#39;ll use the random</span>
  <span style="color:#75715e"># cookie effect we generated earlier</span>
  <span style="color:#a6e22e">mutate</span>(happiness_effect <span style="color:#f92672">=</span> happiness_baseline <span style="color:#f92672">+</span>
           (cookie_effect <span style="color:#f92672">*</span> cookies) <span style="color:#f92672">+</span>
           (<span style="color:#ae81ff">0.91</span> <span style="color:#f92672">*</span> color_blue_binary)) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Rescale to 3-10, since that&#39;s what the original happiness column looked like</span>
  <span style="color:#a6e22e">mutate</span>(happiness <span style="color:#f92672">=</span> <span style="color:#a6e22e">rescale</span>(happiness_effect, to <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">10</span>)))
<span style="color:#a6e22e">head</span>(happiness_cookies_noisier)
<span style="color:#75715e">## # A tibble: 6 x 8</span>
<span style="color:#75715e">##      id happiness_baseline cookies cookie_effect color_blue color_blue_binary happiness_effect happiness</span>
<span style="color:#75715e">##   &lt;int&gt;              &lt;dbl&gt;   &lt;dbl&gt;         &lt;dbl&gt; &lt;fct&gt;      &lt;lgl&gt;                        &lt;dbl&gt;     &lt;dbl&gt;</span>
<span style="color:#75715e">## 1     1                8.7     2.5        0.124  Blue       TRUE                          9.92      8.16</span>
<span style="color:#75715e">## 2     2                6.5     2.5        0.370  Blue       TRUE                          8.34      7.02</span>
<span style="color:#75715e">## 3     3                4.8     2.5        0.326  Blue       TRUE                          6.53      5.72</span>
<span style="color:#75715e">## 4     4                9.6     3.5        0.559  Blue       TRUE                         12.5       9.98</span>
<span style="color:#75715e">## 5     5                6.2     1.5        0.0631 Blue       TRUE                          7.20      6.21</span>
<span style="color:#75715e">## 6     6                6.1     2          0.222  Not blue   FALSE                         6.54      5.73</span>
</code></pre></div><p>Now let&rsquo;s look at the cookie effect in this noisier data:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">model_noisier <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(happiness <span style="color:#f92672">~</span> cookies <span style="color:#f92672">+</span> color_blue, data <span style="color:#f92672">=</span> happiness_cookies_noisier)
<span style="color:#a6e22e">tidy</span>(model_noisier)
<span style="color:#75715e">## # A tibble: 3 x 5</span>
<span style="color:#75715e">##   term           estimate std.error statistic  p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;             &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)       6.11     0.0779     78.4  0.      </span>
<span style="color:#75715e">## 2 cookies           0.213    0.0314      6.79 1.92e-11</span>
<span style="color:#75715e">## 3 color_blueBlue    0.650    0.0671      9.68 3.01e-21</span>
</code></pre></div><p>The effect is a little smaller now because of the extra noise, so we&rsquo;d need to mess with the 0.31 and 0.91 coefficients more to get those numbers back up to 0.25 and 0.75.</p>
<p>While this didn&rsquo;t influence the findings too much here, it can have consequences for other variables. For instance, in the previous section we said that the color blue influences cookie consumption. If the blue effect on cookies isn&rsquo;t precisely 0.5 but follows some sort of distribution (sometimes small, sometimes big, sometimes negative, sometimes zero), that will influence cookies differently. That random effect on cookie consumption will then work together with the random effect of cookies on happiness, resulting in multiple varied values.</p>
<p>For instance, imagine the average effect of liking blue on cookies is 0.5, and the average effect of cookies on happiness is 0.25. For one person, their blue-on-cookie effect might be 0.392, which changes the number of cookies they eat. Their cookie-on-happiness effect is 0.573, which changes their happiness. Both of those random effects work together to generate the final happiness.</p>
<p>If you want more realistic-looking synthetic data, it&rsquo;s a good idea to add some random noise wherever you can.</p>
<h2 id="visualizing-variables-and-relationships">Visualizing variables and relationships</h2>
<p>Going through this process requires <em>a ton</em> of trial and error. You will change all sorts of numbers to make sure the relationships you&rsquo;re building work. This is especially the case if you rescale things, since that rescales your effects. There are a lot of moving parts and this is a complicated process.</p>
<p>You&rsquo;ll run your data generation chunks lots and lots and lots of times, tinkering with the numbers as you go. This example makes it look easy, since it&rsquo;s the final product, but I ran all these chunks over and over again until I got the causal effect and relationships just right.</p>
<p>It&rsquo;s best if you also create plots and models to see what the relationships look like</p>
<h3 id="visualizing-one-variable">Visualizing one variable</h3>
<p>We covered a bunch of distributions in the <a href="/example/random-numbers/">random number generation</a> example, but it&rsquo;s hard to think about what a standard deviation of 2 vs 10 looks like, or what happens when you mess with the shape parameters in a Beta distribution.</p>
<p>It&rsquo;s best to visualize these variables. You could build the variable into your official dataset and then look at it, but I find it&rsquo;s often faster to just look at what a general distribution looks like first. The easiest way to do this is generate a dataset with just one column in it and look at it, either with a histogram or a density plot.</p>
<p>For instance, what does a Beta distribution with <code>shape1 = 3</code> and <code>shape2 = 16</code> look like? The math says it should peak around 0.15ish ($\frac{3}{3 + 16}$), and that looks like the case:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">temp_data <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">tibble</span>(x <span style="color:#f92672">=</span> <span style="color:#a6e22e">rbeta</span>(<span style="color:#ae81ff">10000</span>, shape1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, shape2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>))

plot1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">ggplot</span>(temp_data, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> x)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_histogram</span>(binwidth <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.05</span>, boundary <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;white&#34;</span>)

plot2 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">ggplot</span>(temp_data, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> x)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_density</span>()

plot1 <span style="color:#f92672">+</span> plot2
</code></pre></div><p><img src="/example/synthetic-data_files/figure-html/vis-beta-example-1.png" width="65%" style="display: block; margin: auto;" /></p>
<p>What if we want a normal distribution centered around 100, with most values range from 50 to 150. That&rsquo;s range of ±50, but that doesn&rsquo;t mean the <code>sd</code> will be 50—it&rsquo;ll be much smaller than that, like 25ish. Tinker with the numbers until it looks right.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">temp_data <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">tibble</span>(x <span style="color:#f92672">=</span> <span style="color:#a6e22e">rnorm</span>(<span style="color:#ae81ff">10000</span>, mean <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>, sd <span style="color:#f92672">=</span> <span style="color:#ae81ff">25</span>))

plot1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">ggplot</span>(temp_data, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> x)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_histogram</span>(binwidth <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>, boundary <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;white&#34;</span>)

plot2 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">ggplot</span>(temp_data, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> x)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_density</span>()

plot1 <span style="color:#f92672">+</span> plot2
</code></pre></div><p><img src="/example/synthetic-data_files/figure-html/vis-normal-example-1.png" width="65%" style="display: block; margin: auto;" /></p>
<h3 id="visualizing-two-continuous-variables">Visualizing two continuous variables</h3>
<p>If you have two continuous/numeric columns, it&rsquo;s best to use a scatterplot. For instance, let&rsquo;s make two columns based on the Beta and normal distributions above, and we&rsquo;ll make it so that y goes up by 0.25 for every increase in x, along with some noise:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">set.seed</span>(<span style="color:#ae81ff">1234</span>)

temp_data <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">tibble</span>(
  x <span style="color:#f92672">=</span> <span style="color:#a6e22e">rnorm</span>(<span style="color:#ae81ff">1000</span>, mean <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>, sd <span style="color:#f92672">=</span> <span style="color:#ae81ff">25</span>)
) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">mutate</span>(y <span style="color:#f92672">=</span> <span style="color:#a6e22e">rbeta</span>(<span style="color:#ae81ff">1000</span>, shape1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, shape2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>) <span style="color:#f92672">+</span>  <span style="color:#75715e"># Baseline distribution</span>
           (<span style="color:#ae81ff">0.25</span> <span style="color:#f92672">*</span> x) <span style="color:#f92672">+</span>  <span style="color:#75715e"># Effect of x</span>
           <span style="color:#a6e22e">rnorm</span>(<span style="color:#ae81ff">1000</span>, mean <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, sd <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>))  <span style="color:#75715e"># Add some noise</span>

<span style="color:#a6e22e">ggplot</span>(temp_data, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> x, y <span style="color:#f92672">=</span> y)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_point</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_smooth</span>(method <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;lm&#34;</span>)
</code></pre></div><p><img src="/example/synthetic-data_files/figure-html/vis-two-continuous-1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>We can confirm the effect with a model:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">lm</span>(y <span style="color:#f92672">~</span> x, data <span style="color:#f92672">=</span> temp_data) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">tidy</span>()
<span style="color:#75715e">## # A tibble: 2 x 5</span>
<span style="color:#75715e">##   term        estimate std.error statistic  p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)    1.98     1.28        1.54 1.24e- 1</span>
<span style="color:#75715e">## 2 x              0.235    0.0125     18.8  1.49e-67</span>
</code></pre></div><h3 id="visualizing-a-binary-variable-and-a-continuous-variable">Visualizing a binary variable and a continuous variable</h3>
<p>If you have one binary column and one continuous/numeric column, it&rsquo;s generally best to <em>not</em> use a scatterplot. Instead, either look at the distribution of the continuous variable across the binary variable with a faceted histogram or overlaid density plot, or look at the average of the continuous variable across the different values of the binary variable with a point range.</p>
<p>Let&rsquo;s make two columns: a continuous outcome (y) and a binary treatment (x). Being in the treatment group causes an increase of 20 points, on average.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">set.seed</span>(<span style="color:#ae81ff">1234</span>)

temp_data <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">tibble</span>(
  treatment <span style="color:#f92672">=</span> <span style="color:#a6e22e">rbinom</span>(<span style="color:#ae81ff">1000</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, prob <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.5</span>)  <span style="color:#75715e"># Make 1000 0/1 values with 50% chance of each</span>
) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">mutate</span>(outcome <span style="color:#f92672">=</span> <span style="color:#a6e22e">rbeta</span>(<span style="color:#ae81ff">1000</span>, shape1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, shape2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>) <span style="color:#f92672">+</span>  <span style="color:#75715e"># Baseline distribution</span>
           (<span style="color:#ae81ff">20</span> <span style="color:#f92672">*</span> treatment) <span style="color:#f92672">+</span>  <span style="color:#75715e"># Effect of treatment</span>
           <span style="color:#a6e22e">rnorm</span>(<span style="color:#ae81ff">1000</span>, mean <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, sd <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>)) <span style="color:#f92672">%&gt;%</span>   <span style="color:#75715e"># Add some noise</span>
  <span style="color:#a6e22e">mutate</span>(treatment <span style="color:#f92672">=</span> <span style="color:#a6e22e">factor</span>(treatment))  <span style="color:#75715e"># Make treatment a factor/categorical variable</span>
</code></pre></div><p>We can check the numbers with a model:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">lm</span>(outcome <span style="color:#f92672">~</span> treatment, data <span style="color:#f92672">=</span> temp_data) <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">tidy</span>()
<span style="color:#75715e">## # A tibble: 2 x 5</span>
<span style="color:#75715e">##   term        estimate std.error statistic  p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)    0.244     0.935     0.261 7.94e- 1</span>
<span style="color:#75715e">## 2 treatment1    20.9       1.30     16.1   4.70e-52</span>
</code></pre></div><p>Here&rsquo;s what that looks like as a histogram:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">ggplot</span>(temp_data, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> outcome, fill <span style="color:#f92672">=</span> treatment)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_histogram</span>(binwidth <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>, color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;white&#34;</span>, boundary <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">guides</span>(fill <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>) <span style="color:#f92672">+</span>  <span style="color:#75715e"># Turn off the fill legend since it&#39;s redundant</span>
  <span style="color:#a6e22e">facet_wrap</span>(<span style="color:#a6e22e">vars</span>(treatment), ncol <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>)
</code></pre></div><p><img src="/example/synthetic-data_files/figure-html/vis-histogram-1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>And as overlapping densities:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">ggplot</span>(temp_data, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> outcome, fill <span style="color:#f92672">=</span> treatment)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_density</span>(alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.5</span>)
</code></pre></div><p><img src="/example/synthetic-data_files/figure-html/vis-density-1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>And with a point range:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># hahaha these error bars are tiny</span>
<span style="color:#a6e22e">ggplot</span>(temp_data, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> treatment, y <span style="color:#f92672">=</span> outcome, color <span style="color:#f92672">=</span> treatment)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">stat_summary</span>(geom <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;pointrange&#34;</span>, fun.data <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;mean_se&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">guides</span>(color <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>)  <span style="color:#75715e"># Turn off the color legend since it&#39;s redundant</span>
</code></pre></div><p><img src="/example/synthetic-data_files/figure-html/vis-pointrange-1.png" width="75%" style="display: block; margin: auto;" /></p>
<h2 id="specific-examples">Specific examples</h2>
<h3 id="tldr-the-general-process">tl;dr: The general process</h3>
<p>Those previous sections go into a lot of detail. In general, here&rsquo;s the process you should follow when building relationships in synthetic data:</p>
<ol>
<li>Draw a DAG that maps out how all the columns you care about are related.</li>
<li>Specify how those nodes are measured.</li>
<li>Specify the relationships between the nodes based on the DAG equations.</li>
<li>Generate random columns that stand alone. Generate related columns using regression math. Consider adding random noise. This is an entirely trial and error process until you get numbers that look good. Rely <em>heavily</em> on plots as you try different coefficients and parameters. Optionally rescale any columns that go out of reasonable bounds. If you rescale, you&rsquo;ll need to tinker with the coefficients you used since the final effects will also get rescaled.</li>
<li>Verify all relationships with plots and models.</li>
<li>Try it out!</li>
<li>Save the data.</li>
</ol>
<h3 id="creating-an-effect-in-an-observational-dag">Creating an effect in an observational DAG</h3>
<ol>
<li>
<p><strong>Draw a DAG that maps out how all the columns you care about are related.</strong></p>
<p>Here&rsquo;s a simple DAG that shows the causal effect of mosquito net usage on malaria risk. Income and health both influence and confound net use and malaria risk, and income also influences health.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">mosquito_dag <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dagify</span>(mal <span style="color:#f92672">~</span> net <span style="color:#f92672">+</span> inc <span style="color:#f92672">+</span> hlth,
                       net <span style="color:#f92672">~</span> inc <span style="color:#f92672">+</span> hlth,
                       hlth <span style="color:#f92672">~</span> inc,
                       coords <span style="color:#f92672">=</span> <span style="color:#a6e22e">list</span>(x <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(mal <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>, net <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, inc <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, hlth <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>),
                                     y <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(mal <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, net <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, inc <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, hlth <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>)))
<span style="color:#a6e22e">ggdag</span>(mosquito_dag) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme_dag</span>()
</code></pre></div><p><img src="/example/synthetic-data_files/figure-html/observational-dag-1.png" width="75%" style="display: block; margin: auto;" /></p>
</li>
<li>
<p><strong>Specify how those nodes are measured.</strong></p>
<p>For the sake of this example, we&rsquo;ll measure these nodes like so. See <a href="/example/random-numbers">the random number example</a> for more details about the distributions.</p>
<ul>
<li>
<p><strong>Malaria risk</strong>: scale from 0–100, mostly around 40, but ranging from 10ish to 80ish. Best to use a Beta distribution.</p>
</li>
<li>
<p><strong>Net use</strong>: binary 0/1, TRUE/FALSE variable, where 50% of people use nets. Best to use a binomial distribution. However, since we want to use other variables that increase the likelihood of using a net, we&rsquo;ll do some cool tricky stuff, explained later.</p>
</li>
<li>
<p><strong>Income</strong>: weekly income, measured in dollars, mostly around 500 ± 300. Best to use a normal distribution.</p>
</li>
<li>
<p><strong>Health</strong>: scale from 0–100, mostly around 70, but ranging from 50ish to 100. Best to use a Beta distribution.</p>
</li>
</ul>
</li>
<li>
<p><strong>Specify the relationships between the nodes based on the DAG equations.</strong></p>
<p>There are three models in this DAG:</p>
<ul>
<li>
<p><strong><code>hlth ~ inc</code></strong>: Income influences health. We&rsquo;ll assume that every 10 dollars/week is associated with a 1 point increase in health (so a 1 dollar incrrease is associated with a 0.02 point increase in health)</p>
</li>
<li>
<p><strong><code>net ~ inc + hlth</code></strong>: Income and health both increase the probability of net usage. This is where we do some cool tricky stuff.</p>
<p>Both income and health have an effect on the probability of bed net use, but bed net use is measured as a 0/1, TRUE/FALSE variable. If we run a regression with <code>net</code> as the outcome, we can&rsquo;t really interpret the coefficients like &ldquo;a 1 point increase in health is associated with a 0.42 point increase in bed net being TRUE.&rdquo; That doesn&rsquo;t even make sense.</p>
<p>Ordinarily, when working with binary outcome variables, you use logistic regression models (see <a href="/example/matching-ipw/#oversimplified-crash-course-in-logistic-regression">the crash course we had when talking about propensity scores here</a>). In this kind of regression, the coefficients in the model represent changes in the <em>log odds</em> of using a net. As we discuss in <a href="/example/matching-ipw/#oversimplified-crash-course-in-logistic-regression">the crash course section</a>, log odds are typically impossible to interpet. If you exponentiate them, you get odds ratios, which let you say things like &ldquo;a 1 point increase in health is associated with a 15% increase in the likelihood of using a net.&rdquo; Technically we could include coefficients for a logistic regression model and simulate probabilities of using a net or not using log odds and odds ratios (and that&rsquo;s what I do in the rain barrel data from Problem Set 3 (<a href="https://github.com/andrewheiss/evalf20.classes.andrewheiss.com/blob/master/content/assignment/03-problem-set.Rmd#L225" target="_blank" rel="noopener">see code here</a>)), but that&rsquo;s really hard to wrap your head around since you&rsquo;re dealing with strange uninterpretable coefficients. So we won&rsquo;t do that here.</p>
<p>Instead, we&rsquo;ll do some fun trickery. We&rsquo;ll create something called a &ldquo;bed net score&rdquo; that gets bigger as income and health increase. We&rsquo;ll say that a 1 point increase in health score is associated with a 1.5 point increase in bed net score, and a 1 dollar increase in income is associated with a 0.5 point increase in bed net score. This results in a column that ranges all over the place, from 200 to 500 (in this case; that won&rsquo;t always be true). This column definitely doesn&rsquo;t look like a TRUE/FALSE binary column—it&rsquo;s just a bunch of numbers. That&rsquo;s okay!</p>
<p>We&rsquo;ll then use the <code>rescale()</code> function from the <strong>scales</strong> package to take this bed net score and scale it down so that it goes from 0.05 to 0.95. This represents a person&rsquo;s probability of using a bed net.</p>
<p>Finally, we&rsquo;ll use that probability in the <code>rbinom()</code> function to generate a 0 or 1 for each person. Some people will have a high probability because of their income and health, like 0.9, and will most likely use a net. Some people might have a 0.15 probability and will likely not use a net.</p>
<p>When you generate binary variables like this, it&rsquo;s hard to know the exact effect you&rsquo;ll get, so it&rsquo;s best to tinker with the numbers until you see relationships that you want.</p>
</li>
<li>
<p><strong><code>mal ~ net + inc + hlth</code></strong>: Finally net use, income, and health all have an effect on the risk of malaria. Building this relationship is easy since it&rsquo;s just a regular linear regression model (since malaria risk is not binary). We&rsquo;ll say that a 1 dollar increase in income is associated with a <em>decrease</em> in risk, a 1 point increase in health is associated with a <em>decrease</em> in risk, and using a net is associated with a 15 point <em>decrease</em> in risk. That&rsquo;s the casual effect we&rsquo;re building in to the DAG.</p>
</li>
</ul>
</li>
<li>
<p><strong>Generate random columns that stand alone. Generate related columns using regression math. Consider adding random noise. This is an entirely trial and error process until you get numbers that look good. Rely <em>heavily</em> on plots as you try different coefficients and parameters. Optionally rescale any columns that go out of reasonable bounds. If you rescale, you&rsquo;ll need to tinker with the coefficients you used since the final effects will also get rescaled.</strong></p>
<p>Here we go! Let&rsquo;s make some data. I&rsquo;ll comment the code below so you can see what&rsquo;s happening at each step.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Make this randomness consistent</span>
<span style="color:#a6e22e">set.seed</span>(<span style="color:#ae81ff">1234</span>)
   
<span style="color:#75715e"># Simulate 1138 people (just for fun)</span>
n_people <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1138</span>
   
net_data <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">tibble</span>(
  <span style="color:#75715e"># Make an ID column (not necessary, but nice to have)</span>
  id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>n_people,
  <span style="color:#75715e"># Generate income variable: normal, 500 ± 300</span>
  income <span style="color:#f92672">=</span> <span style="color:#a6e22e">rnorm</span>(n_people, mean <span style="color:#f92672">=</span> <span style="color:#ae81ff">500</span>, sd <span style="color:#f92672">=</span> <span style="color:#ae81ff">75</span>)
) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Generate health variable: beta, centered around 70ish</span>
  <span style="color:#a6e22e">mutate</span>(health_base <span style="color:#f92672">=</span> <span style="color:#a6e22e">rbeta</span>(n_people, shape1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>, shape2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">100</span>,
         <span style="color:#75715e"># Health increases by 0.02 for every dollar in income</span>
         health_income_effect <span style="color:#f92672">=</span> income <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.02</span>,
         <span style="color:#75715e"># Make the final health score and add some noise</span>
         health <span style="color:#f92672">=</span> health_base <span style="color:#f92672">+</span> health_income_effect <span style="color:#f92672">+</span> <span style="color:#a6e22e">rnorm</span>(n_people, mean <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, sd <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>),
         <span style="color:#75715e"># Rescale so it doesn&#39;t go above 100</span>
         health <span style="color:#f92672">=</span> <span style="color:#a6e22e">rescale</span>(health, to <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#a6e22e">min</span>(health), <span style="color:#ae81ff">100</span>))) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Generate net variable based on income, health, and random noise</span>
  <span style="color:#a6e22e">mutate</span>(net_score <span style="color:#f92672">=</span> (<span style="color:#ae81ff">0.5</span> <span style="color:#f92672">*</span> income) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">1.5</span> <span style="color:#f92672">*</span> health) <span style="color:#f92672">+</span> <span style="color:#a6e22e">rnorm</span>(n_people, mean <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, sd <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>),
         <span style="color:#75715e"># Scale net score down to 0.05 to 0.95 to create a probability of using a net</span>
         net_probability <span style="color:#f92672">=</span> <span style="color:#a6e22e">rescale</span>(net_score, to <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0.05</span>, <span style="color:#ae81ff">0.95</span>)),
         <span style="color:#75715e"># Randomly generate a 0/1 variable using that probability</span>
         net <span style="color:#f92672">=</span> <span style="color:#a6e22e">rbinom</span>(n_people, <span style="color:#ae81ff">1</span>, net_probability)) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Finally generate a malaria risk variable based on income, health, net use,</span>
  <span style="color:#75715e"># and random noise</span>
  <span style="color:#a6e22e">mutate</span>(malaria_risk_base <span style="color:#f92672">=</span> <span style="color:#a6e22e">rbeta</span>(n_people, shape1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>, shape2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">100</span>,
         <span style="color:#75715e"># Risk goes down by 10 when using a net. Because we rescale things,</span>
         <span style="color:#75715e"># though, we have to make the effect a lot bigger here so it scales</span>
         <span style="color:#75715e"># down to -10. Risk also decreases as health and income go up. I played</span>
         <span style="color:#75715e"># with these numbers until they created reasonable coefficients.</span>
         malaria_effect <span style="color:#f92672">=</span> (<span style="color:#ae81ff">-30</span> <span style="color:#f92672">*</span> net) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">-1.9</span> <span style="color:#f92672">*</span> health) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">-0.1</span> <span style="color:#f92672">*</span> income),
         <span style="color:#75715e"># Make the final malaria risk score and add some noise</span>
         malaria_risk <span style="color:#f92672">=</span> malaria_risk_base <span style="color:#f92672">+</span> malaria_effect <span style="color:#f92672">+</span> <span style="color:#a6e22e">rnorm</span>(n_people, <span style="color:#ae81ff">0</span>, sd <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>),
         <span style="color:#75715e"># Rescale so it doesn&#39;t go below 0,</span>
         malaria_risk <span style="color:#f92672">=</span> <span style="color:#a6e22e">rescale</span>(malaria_risk, to <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">70</span>)))
   
<span style="color:#75715e"># Look at all these columns!</span>
<span style="color:#a6e22e">head</span>(net_data)
<span style="color:#75715e">## # A tibble: 6 x 11</span>
<span style="color:#75715e">##      id income health_base health_income_effect health net_score net_probability   net malaria_risk_base malaria_effect malaria_risk</span>
<span style="color:#75715e">##   &lt;int&gt;  &lt;dbl&gt;       &lt;dbl&gt;                &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;           &lt;dbl&gt; &lt;int&gt;             &lt;dbl&gt;          &lt;dbl&gt;        &lt;dbl&gt;</span>
<span style="color:#75715e">## 1     1   409.        61.2                 8.19   63.1      301.           0.369     0              37.9          -161.         45.1</span>
<span style="color:#75715e">## 2     2   521.        83.9                10.4    83.5      409.           0.684     1              55.0          -241.         23.4</span>
<span style="color:#75715e">## 3     3   581.        64.6                11.6    73.0      426.           0.735     0              53.0          -197.         36.5</span>
<span style="color:#75715e">## 4     4   324.        62.0                 6.48   60.6      255.           0.235     0              68.4          -148.         58.7</span>
<span style="color:#75715e">## 5     5   532.        69.2                10.6    73.4      373.           0.578     1              63.2          -223.         32.7</span>
<span style="color:#75715e">## 6     6   538.        36.6                10.8    42.6      295.           0.351     0              38.6          -135.         52.5</span>
</code></pre></div></li>
<li>
<p><strong>Verify all relationships with plots and models.</strong></p>
<p>Let&rsquo;s see if we have the relationships we want. Income looks like it&rsquo;s associated with health:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">ggplot</span>(net_data, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> income, y <span style="color:#f92672">=</span> health)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_point</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_smooth</span>(method <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;lm&#34;</span>)
</code></pre></div><p><img src="/example/synthetic-data_files/figure-html/check-income-health-1.png" width="75%" style="display: block; margin: auto;" /></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">   
<span style="color:#a6e22e">lm</span>(health <span style="color:#f92672">~</span> income, data <span style="color:#f92672">=</span> net_data) <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">tidy</span>()
<span style="color:#75715e">## # A tibble: 2 x 5</span>
<span style="color:#75715e">##   term        estimate std.error statistic  p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)  59.1      2.54        23.3  2.24e-98</span>
<span style="color:#75715e">## 2 income        0.0169   0.00504      3.36 8.15e- 4</span>
</code></pre></div><p>It looks like richer and healthier people are more likely to use nets:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">net_income <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">ggplot</span>(net_data, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> income, fill <span style="color:#f92672">=</span> <span style="color:#a6e22e">as.factor</span>(net))) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_density</span>(alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.7</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme</span>(legend.position <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bottom&#34;</span>)
   
net_health <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">ggplot</span>(net_data, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> health, fill <span style="color:#f92672">=</span> <span style="color:#a6e22e">as.factor</span>(net))) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_density</span>(alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.7</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme</span>(legend.position <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bottom&#34;</span>)
   
net_income <span style="color:#f92672">+</span> net_health
</code></pre></div><p><img src="/example/synthetic-data_files/figure-html/check-income-health-nets-1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Income increasing makes it 1% more likely to use a net; health increasing make it 2% more likely to use a net:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">glm</span>(net <span style="color:#f92672">~</span> income <span style="color:#f92672">+</span> health, family <span style="color:#f92672">=</span> <span style="color:#a6e22e">binomial</span>(link <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;logit&#34;</span>), data <span style="color:#f92672">=</span> net_data) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">tidy</span>(exponentiate <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>)
<span style="color:#75715e">## # A tibble: 3 x 5</span>
<span style="color:#75715e">##   term        estimate std.error statistic  p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)   0.0186  0.532        -7.49 6.64e-14</span>
<span style="color:#75715e">## 2 income        1.01    0.000864      6.47 9.93e-11</span>
<span style="color:#75715e">## 3 health        1.02    0.00491       3.89 9.92e- 5</span>
</code></pre></div></li>
<li>
<p><strong>Try it out!</strong></p>
<p>Is the effect in there? Let&rsquo;s try finding it by controlling for our two backdoors: health and income. Ordinarily we should do something like <a href="/example/matching-ipw/">matching or inverse probability weighting</a>, but we&rsquo;ll just do regular regression here (which is okay-ish, since all these variables are indeed linearly related with each other—we made them that way!)</p>
<p>If we just look at the effect of nets on malaria risk without any statistical adjustment, we see that net cause a decrease of 13 points in malaria risk. This is wrong though becuase there&rsquo;s confounding.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Wrong correlation-is-not-causation effect</span>
model_net_naive <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(malaria_risk <span style="color:#f92672">~</span> net, data <span style="color:#f92672">=</span> net_data)
<span style="color:#a6e22e">tidy</span>(model_net_naive)
<span style="color:#75715e">## # A tibble: 2 x 5</span>
<span style="color:#75715e">##   term        estimate std.error statistic   p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)     41.9     0.413     102.  0.       </span>
<span style="color:#75715e">## 2 net            -13.6     0.572     -23.7 2.90e-101</span>
</code></pre></div><p>If we control for the confounders, we get the 10 point ATE. It works!</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Correctly adjusted ATE effect</span>
model_net_ate <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(malaria_risk <span style="color:#f92672">~</span> net <span style="color:#f92672">+</span> health <span style="color:#f92672">+</span> income, data <span style="color:#f92672">=</span> net_data)
<span style="color:#a6e22e">tidy</span>(model_net_ate)
<span style="color:#75715e">## # A tibble: 4 x 5</span>
<span style="color:#75715e">##   term        estimate std.error statistic   p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)  97.3      1.28         76.1 0.       </span>
<span style="color:#75715e">## 2 net         -10.5      0.317       -33.2 1.32e-169</span>
<span style="color:#75715e">## 3 health       -0.608    0.0123      -49.4 1.25e-284</span>
<span style="color:#75715e">## 4 income       -0.0320   0.00213     -15.0 1.20e- 46</span>
</code></pre></div></li>
<li>
<p><strong>Save the data.</strong></p>
<p>Since it works, let&rsquo;s save it:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># In the end, all we need is id, income, health, net, and malaria risk:</span>
net_data_final <span style="color:#f92672">&lt;-</span> net_data <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">select</span>(id, income, health, net, malaria_risk)
<span style="color:#a6e22e">head</span>(net_data_final)
<span style="color:#75715e">## # A tibble: 6 x 5</span>
<span style="color:#75715e">##      id income health   net malaria_risk</span>
<span style="color:#75715e">##   &lt;int&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;int&gt;        &lt;dbl&gt;</span>
<span style="color:#75715e">## 1     1   409.   63.1     0         45.1</span>
<span style="color:#75715e">## 2     2   521.   83.5     1         23.4</span>
<span style="color:#75715e">## 3     3   581.   73.0     0         36.5</span>
<span style="color:#75715e">## 4     4   324.   60.6     0         58.7</span>
<span style="color:#75715e">## 5     5   532.   73.4     1         32.7</span>
<span style="color:#75715e">## 6     6   538.   42.6     0         52.5</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Save it as a CSV file</span>
<span style="color:#a6e22e">write_csv</span>(net_data_final, <span style="color:#e6db74">&#34;data/bed_nets.csv&#34;</span>)
</code></pre></div></li>
</ol>
<h3 id="brief-pep-talk-intermission">Brief pep talk intermission</h3>
<p>Generating data for a full complete observational DAG like the example above is complicated and hard. These other forms of causal inference are <em>design-based</em> (i.e. tied to specific contexts like before/after treatment/control or arbitrary cutoffs) instead of <em>model-based</em>, so they&rsquo;re actually a lot easier to simulate! So don&rsquo;t be scared away yet!</p>
<h3 id="creating-an-effect-for-rcts">Creating an effect for RCTs</h3>
<ol>
<li>
<p><strong>Draw a DAG that maps out how all the columns you care about are related.</strong></p>
<p>RCTs are great because they make DAGs really easy! In a well-randomized RCT, you get to delete all arrows going into the treatment node in a DAG. We&rsquo;ll stick with the same mosquito net situation we just used, but make it randomized:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">rct_dag <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dagify</span>(mal <span style="color:#f92672">~</span> net <span style="color:#f92672">+</span> inc <span style="color:#f92672">+</span> hlth,
                  hlth <span style="color:#f92672">~</span> inc,
                  coords <span style="color:#f92672">=</span> <span style="color:#a6e22e">list</span>(x <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(mal <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>, net <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, inc <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, hlth <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>),
                                y <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(mal <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, net <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, inc <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, hlth <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>)))
<span style="color:#a6e22e">ggdag</span>(rct_dag) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme_dag</span>()
</code></pre></div><p><img src="/example/synthetic-data_files/figure-html/rct-dag-1.png" width="75%" style="display: block; margin: auto;" /></p>
</li>
<li>
<p><strong>Specify how those nodes are measured.</strong></p>
<p>We&rsquo;ll measure these nodes the same way as before:</p>
<ul>
<li>
<p><strong>Malaria risk</strong>: scale from 0–100, mostly around 40, but ranging from 10ish to 80ish. Best to use a Beta distribution.</p>
</li>
<li>
<p><strong>Net use</strong>: binary 0/1, TRUE/FALSE variable, where 50% of people use nets. Best to use a binomial distribution.</p>
</li>
<li>
<p><strong>Income</strong>: weekly income, measured in dollars, mostly around 500 ± 300. Best to use a normal distribution.</p>
</li>
<li>
<p><strong>Health</strong>: scale from 0–100, mostly around 70, but ranging from 50ish to 100. Best to use a Beta distribution.</p>
</li>
</ul>
</li>
<li>
<p><strong>Specify the relationships between the nodes based on the DAG equations.</strong></p>
<p>This is where RCTs are great. Because we removed all the arrows going into <code>net</code>, we don&rsquo;t need to build any relationships that influence net use. Net use is randomized! We don&rsquo;t need to make strange &ldquo;bed net scores&rdquo; and give people boosts according to income or health or anything. There are only two models in this DAG:</p>
<ul>
<li>
<p><strong><code>hlth ~ inc</code></strong>: Income influences health. We&rsquo;ll assume that every 10 dollars/week is associated with a 1 point increase in health (so a 1 dollar incrrease is associated with a 0.02 point increase in health)</p>
</li>
<li>
<p><strong><code>mal ~ net + inc + hlth</code></strong>: Net use, income, and health all have an effect on the risk of malaria. We&rsquo;ll say that a 1 dollar increase in income is associated with a <em>decrease</em> in risk, a 1 point increase in health is associated with a <em>decrease</em> in risk, and using a net is associated with a 15 point <em>decrease</em> in risk. That&rsquo;s the casual effect we&rsquo;re building in to the DAG.</p>
</li>
</ul>
</li>
<li>
<p><strong>Generate random columns that stand alone. Generate related columns using regression math. Consider adding random noise. This is an entirely trial and error process until you get numbers that look good. Rely <em>heavily</em> on plots as you try different coefficients and parameters. Optionally rescale any columns that go out of reasonable bounds. If you rescale, you&rsquo;ll need to tinker with the coefficients you used since the final effects will also get rescaled.</strong></p>
<p>Let&rsquo;s make this data. It&rsquo;ll be a lot easier than the full DAG we did before. Again, I&rsquo;ll comment the code below so you can see what&rsquo;s happening at each step.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Make this randomness consistent</span>
<span style="color:#a6e22e">set.seed</span>(<span style="color:#ae81ff">1234</span>)
   
<span style="color:#75715e"># Simulate 793 people (just for fun)</span>
n_people <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">793</span>
   
rct_data <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">tibble</span>(
  <span style="color:#75715e"># Make an ID column (not necessary, but nice to have)</span>
  id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>n_people,
  <span style="color:#75715e"># Generate income variable: normal, 500 ± 300</span>
  income <span style="color:#f92672">=</span> <span style="color:#a6e22e">rnorm</span>(n_people, mean <span style="color:#f92672">=</span> <span style="color:#ae81ff">500</span>, sd <span style="color:#f92672">=</span> <span style="color:#ae81ff">75</span>)
) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Generate health variable: beta, centered around 70ish</span>
  <span style="color:#a6e22e">mutate</span>(health_base <span style="color:#f92672">=</span> <span style="color:#a6e22e">rbeta</span>(n_people, shape1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>, shape2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">100</span>,
         <span style="color:#75715e"># Health increases by 0.02 for every dollar in income</span>
         health_income_effect <span style="color:#f92672">=</span> income <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.02</span>,
         <span style="color:#75715e"># Make the final health score and add some noise</span>
         health <span style="color:#f92672">=</span> health_base <span style="color:#f92672">+</span> health_income_effect <span style="color:#f92672">+</span> <span style="color:#a6e22e">rnorm</span>(n_people, mean <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, sd <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>),
         <span style="color:#75715e"># Rescale so it doesn&#39;t go above 100</span>
         health <span style="color:#f92672">=</span> <span style="color:#a6e22e">rescale</span>(health, to <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#a6e22e">min</span>(health), <span style="color:#ae81ff">100</span>))) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Randomly assign people to use a net (this is nice and easy!)</span>
  <span style="color:#a6e22e">mutate</span>(net <span style="color:#f92672">=</span> <span style="color:#a6e22e">rbinom</span>(n_people, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0.5</span>)) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Finally generate a malaria risk variable based on income, health, net use,</span>
  <span style="color:#75715e"># and random noise</span>
  <span style="color:#a6e22e">mutate</span>(malaria_risk_base <span style="color:#f92672">=</span> <span style="color:#a6e22e">rbeta</span>(n_people, shape1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>, shape2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">100</span>,
         <span style="color:#75715e"># Risk goes down by 10 when using a net. Because we rescale things,</span>
         <span style="color:#75715e"># though, we have to make the effect a lot bigger here so it scales</span>
         <span style="color:#75715e"># down to -10. Risk also decreases as health and income go up. I played</span>
         <span style="color:#75715e"># with these numbers until they created reasonable coefficients.</span>
         malaria_effect <span style="color:#f92672">=</span> (<span style="color:#ae81ff">-35</span> <span style="color:#f92672">*</span> net) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">-1.9</span> <span style="color:#f92672">*</span> health) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">-0.1</span> <span style="color:#f92672">*</span> income),
         <span style="color:#75715e"># Make the final malaria risk score and add some noise</span>
         malaria_risk <span style="color:#f92672">=</span> malaria_risk_base <span style="color:#f92672">+</span> malaria_effect <span style="color:#f92672">+</span> <span style="color:#a6e22e">rnorm</span>(n_people, <span style="color:#ae81ff">0</span>, sd <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>),
         <span style="color:#75715e"># Rescale so it doesn&#39;t go below 0,</span>
         malaria_risk <span style="color:#f92672">=</span> <span style="color:#a6e22e">rescale</span>(malaria_risk, to <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">70</span>)))
   
<span style="color:#75715e"># Look at all these columns!</span>
<span style="color:#a6e22e">head</span>(rct_data)
<span style="color:#75715e">## # A tibble: 6 x 9</span>
<span style="color:#75715e">##      id income health_base health_income_effect health   net malaria_risk_base malaria_effect malaria_risk</span>
<span style="color:#75715e">##   &lt;int&gt;  &lt;dbl&gt;       &lt;dbl&gt;                &lt;dbl&gt;  &lt;dbl&gt; &lt;int&gt;             &lt;dbl&gt;          &lt;dbl&gt;        &lt;dbl&gt;</span>
<span style="color:#75715e">## 1     1   409.        57.2                 8.19   61.3     1              37.4          -192.         35.1</span>
<span style="color:#75715e">## 2     2   521.        63.3                10.4    69.4     0              33.0          -184.         37.6</span>
<span style="color:#75715e">## 3     3   581.        61.8                11.6    71.9     1              36.4          -230.         24.4</span>
<span style="color:#75715e">## 4     4   324.        42.2                 6.48   45.5     1              52.7          -154.         52.8</span>
<span style="color:#75715e">## 5     5   532.        72.1                10.6    78.5     1              41.9          -237.         23.6</span>
<span style="color:#75715e">## 6     6   538.        82.0                10.8    89.1     0              46.6          -223.         29.9</span>
</code></pre></div></li>
<li>
<p><strong>Verify all relationships with plots and models.</strong></p>
<p>Income still looks like it&rsquo;s associated with health (which isn&rsquo;t surprising, since it&rsquo;s the same code we used for the full DAG earlier):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">ggplot</span>(net_data, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> income, y <span style="color:#f92672">=</span> health)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_point</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_smooth</span>(method <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;lm&#34;</span>)
</code></pre></div><p><img src="/example/synthetic-data_files/figure-html/check-income-health-rct-1.png" width="75%" style="display: block; margin: auto;" /></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">   
<span style="color:#a6e22e">lm</span>(health <span style="color:#f92672">~</span> income, data <span style="color:#f92672">=</span> net_data) <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">tidy</span>()
<span style="color:#75715e">## # A tibble: 2 x 5</span>
<span style="color:#75715e">##   term        estimate std.error statistic  p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)  59.1      2.54        23.3  2.24e-98</span>
<span style="color:#75715e">## 2 income        0.0169   0.00504      3.36 8.15e- 4</span>
</code></pre></div></li>
<li>
<p><strong>Try it out!</strong></p>
<p>Is the effect in there? With an RCT, all we really need to do is compare the outcome across treatment and control groups—because there&rsquo;s no confounding, we don&rsquo;t need to control for anything. Ordinarily we should check for balance across characteristics like health and income (and maybe generate other demographic columns) like <a href="/example/rcts/">we did in the RCT example</a>, but we&rsquo;ll skip all that here since we&rsquo;re just checking to see if the effect is there.</p>
<p>It looks like using nets <em>causes</em> an average decrease of 10 risk points. Great!</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Correct RCT-based ATE</span>
model_rct <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(malaria_risk <span style="color:#f92672">~</span> net, data <span style="color:#f92672">=</span> rct_data)
<span style="color:#a6e22e">tidy</span>(model_rct)
<span style="color:#75715e">## # A tibble: 2 x 5</span>
<span style="color:#75715e">##   term        estimate std.error statistic  p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)     40.8     0.463      88.0 0.      </span>
<span style="color:#75715e">## 2 net            -10.2     0.653     -15.7 2.22e-48</span>
</code></pre></div><p>Just for fun, if we control for health and income, we&rsquo;ll get basically the same effect, since they don&rsquo;t actualy confound the relationship and don&rsquo;t really explain anything useful.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Controlling for stuff even though we don&#39;t need to</span>
model_rct_controls <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(malaria_risk <span style="color:#f92672">~</span> net <span style="color:#f92672">+</span> health <span style="color:#f92672">+</span> income, data <span style="color:#f92672">=</span> rct_data)
<span style="color:#a6e22e">tidy</span>(model_rct_controls)
<span style="color:#75715e">## # A tibble: 4 x 5</span>
<span style="color:#75715e">##   term        estimate std.error statistic   p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)  97.7      1.45         67.3 0.       </span>
<span style="color:#75715e">## 2 net         -10.8      0.344       -31.3 2.27e-140</span>
<span style="color:#75715e">## 3 health       -0.586    0.0140      -41.8 1.67e-202</span>
<span style="color:#75715e">## 4 income       -0.0310   0.00230     -13.5 1.75e- 37</span>
</code></pre></div></li>
<li>
<p><strong>Save the data.</strong></p>
<p>The data works, so let&rsquo;s get rid of the intermediate columns we don&rsquo;t need and save it as a CSV file.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># In the end, all we need is id, income, health, net, and malaria risk:</span>
rct_data_final <span style="color:#f92672">&lt;-</span> rct_data <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">select</span>(id, income, health, net, malaria_risk)
<span style="color:#a6e22e">head</span>(rct_data_final)
<span style="color:#75715e">## # A tibble: 6 x 5</span>
<span style="color:#75715e">##      id income health   net malaria_risk</span>
<span style="color:#75715e">##   &lt;int&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;int&gt;        &lt;dbl&gt;</span>
<span style="color:#75715e">## 1     1   409.   61.3     1         35.1</span>
<span style="color:#75715e">## 2     2   521.   69.4     0         37.6</span>
<span style="color:#75715e">## 3     3   581.   71.9     1         24.4</span>
<span style="color:#75715e">## 4     4   324.   45.5     1         52.8</span>
<span style="color:#75715e">## 5     5   532.   78.5     1         23.6</span>
<span style="color:#75715e">## 6     6   538.   89.1     0         29.9</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Save it as a CSV file</span>
<span style="color:#a6e22e">write_csv</span>(rct_data_final, <span style="color:#e6db74">&#34;data/bed_nets_rct.csv&#34;</span>)
</code></pre></div></li>
</ol>
<h3 id="creating-an-effect-for-diff-in-diff">Creating an effect for diff-in-diff</h3>
<ol>
<li>
<p><strong>Draw a DAG that maps out how all the columns you care about are related.</strong></p>
<p>Difference-in-differences approaches to causal inference are not based on <em>models</em> but on <em>context</em> or research design. You need comparable treatment and control groups before and after some policy or program is implemented.</p>
<p>We&rsquo;ll keep with our mosquito net example and pretend that two cities in some country are dealing with malaria infections. City B rolls out a free net program in 2017; City A does not. Here&rsquo;s what the DAG looks like:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">did_dag <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dagify</span>(mal <span style="color:#f92672">~</span> net <span style="color:#f92672">+</span> year <span style="color:#f92672">+</span> city,
                  net <span style="color:#f92672">~</span> year <span style="color:#f92672">+</span> city,
                  coords <span style="color:#f92672">=</span> <span style="color:#a6e22e">list</span>(x <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(mal <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, net <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, year <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, city <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>),
                                y <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(mal <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, net <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, year <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, city <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>)))
<span style="color:#a6e22e">ggdag</span>(did_dag) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme_dag</span>()
</code></pre></div><p><img src="/example/synthetic-data_files/figure-html/did-dag-1.png" width="75%" style="display: block; margin: auto;" /></p>
</li>
<li>
<p><strong>Specify how those nodes are measured.</strong></p>
<p>Here&rsquo;s how we&rsquo;ll measure these nodes:</p>
<ul>
<li>
<p><strong>Malaria risk</strong>: scale from 0–100, mostly around 60, but ranging from 30ish to 90ish. Best to use a Beta distribution.</p>
</li>
<li>
<p><strong>Net use</strong>: binary 0/1, TRUE/FALSE variable. This is technically binomial, but we don&rsquo;t need to simulate it since it will only happen for people who are in the treatment city after the universal net rollout.</p>
</li>
<li>
<p><strong>Year</strong>: year ranging from 2013 to 2020. Best to use a uniform distribution.</p>
</li>
<li>
<p><strong>City</strong>: binary 0/1, City A/City B variable. Best to use a binomial distribution.</p>
</li>
</ul>
</li>
<li>
<p><strong>Specify the relationships between the nodes based on the DAG equations.</strong></p>
<p>There are two models in the DAG:</p>
<ul>
<li>
<p><strong><code>net ~ year + city</code></strong>: Net use is determined by being in City B <em>and</em> being after 2017. We&rsquo;ll assume perfect compliance here (but it&rsquo;s fairly easy to simulate non-compliance and have some people in City A use nets after 2017, and some people in both cities use nets before 2017).</p>
</li>
<li>
<p><strong><code>mal ~ net + year + city</code></strong>: Malaria risk is determined by net use, year, and city. It&rsquo;s determined by lots of other things too (like we saw in the previous DAGs), but since we&rsquo;re assuming that the two cities are comparable treatment and control groups, we don&rsquo;t need to worry about things like health, income, age, etc.</p>
<p>We&rsquo;ll pretend that in general, City B has historicallly had a problem with malaria and people there have had higher risk: being in City B increases malaria risk by 5 points, on average. Over time, both cities have worked on mosquito abatement, so average malaria risk has decreased by 2 points per year (in both cities, because we believe in parallel trends). Using a mosquito net causes a decrease of 10 points on average. That&rsquo;s our causal effect.</p>
</li>
</ul>
</li>
<li>
<p><strong>Generate random columns that stand alone. Generate related columns using regression math. Consider adding random noise. This is an entirely trial and error process until you get numbers that look good. Rely <em>heavily</em> on plots as you try different coefficients and parameters. Optionally rescale any columns that go out of reasonable bounds. If you rescale, you&rsquo;ll need to tinker with the coefficients you used since the final effects will also get rescaled.</strong></p>
<p>Generation time! Heavily annotated code below:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Make this randomness consistent</span>
<span style="color:#a6e22e">set.seed</span>(<span style="color:#ae81ff">1234</span>)
   
<span style="color:#75715e"># Simulate 2567 people (just for fun)</span>
n_people <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">2567</span>
   
did_data <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">tibble</span>(
  <span style="color:#75715e"># Make an ID column (not necessary, but nice to have)</span>
  id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>n_people,
  <span style="color:#75715e"># Generate year variable: uniform, between 2013 and 2020. Round so it&#39;s whole.</span>
  year <span style="color:#f92672">=</span> <span style="color:#a6e22e">round</span>(<span style="color:#a6e22e">runif</span>(n_people, min <span style="color:#f92672">=</span> <span style="color:#ae81ff">2013</span>, max <span style="color:#f92672">=</span> <span style="color:#ae81ff">2020</span>), <span style="color:#ae81ff">0</span>),
  <span style="color:#75715e"># Generate city variable: binomial, 50% chance of being in a city. We&#39;ll use</span>
  <span style="color:#75715e"># sample() instead of rbinom()</span>
  city <span style="color:#f92672">=</span> <span style="color:#a6e22e">sample</span>(<span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;City A&#34;</span>, <span style="color:#e6db74">&#34;City B&#34;</span>), n_people, replace <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>)
) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Generate net variable. We&#39;re assuming perfect compliance, so this will only</span>
  <span style="color:#75715e"># be TRUE for people in City B after 2017</span>
  <span style="color:#a6e22e">mutate</span>(net <span style="color:#f92672">=</span> <span style="color:#a6e22e">ifelse</span>(city <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;City B&#34;</span> <span style="color:#f92672">&amp;</span> year <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">2017</span>, <span style="color:#66d9ef">TRUE</span>, <span style="color:#66d9ef">FALSE</span>)) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Generate a malaria risk variable based on year, city, net use, and random noise</span>
  <span style="color:#a6e22e">mutate</span>(malaria_risk_base <span style="color:#f92672">=</span> <span style="color:#a6e22e">rbeta</span>(n_people, shape1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">6</span>, shape2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">100</span>,
         <span style="color:#75715e"># Risk goes up if you&#39;re in City B because they have a worse problem.</span>
         <span style="color:#75715e"># We could just say &#34;city_effect = 5&#34; and give everyone in City A an</span>
         <span style="color:#75715e"># exact 5-point boost, but to add some noise, we&#39;ll give people an</span>
         <span style="color:#75715e"># average boost using rnorm(). Some people might go up 7, some might go</span>
         <span style="color:#75715e"># up 1, some might go down 2</span>
         city_effect <span style="color:#f92672">=</span> <span style="color:#a6e22e">ifelse</span>(city <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;City B&#34;</span>, <span style="color:#a6e22e">rnorm</span>(n_people, mean <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>, sd <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>), <span style="color:#ae81ff">0</span>),
         <span style="color:#75715e"># Risk goes down by 2 points on average every year. Creating this</span>
         <span style="color:#75715e"># effect with regression would work fine (-2 * year), except the years</span>
         <span style="color:#75715e"># are huge here (-2 * 2013 and -2 * 2020, etc.) So first we create a</span>
         <span style="color:#75715e"># smaller year column where 2013 is year 1, 2014 is year 2, and so on,</span>
         <span style="color:#75715e"># that way we can say -2 * 1 and -2 * 6, or whatever.</span>
         <span style="color:#75715e"># Also, rather than make risk go down by *exactly* 2 every year, we&#39;ll</span>
         <span style="color:#75715e"># add some noise with rnorm(), so for some people it&#39;ll go down by 1 or</span>
         <span style="color:#75715e"># 4 or up by 1, and so on</span>
         year_smaller <span style="color:#f92672">=</span> year <span style="color:#f92672">-</span> <span style="color:#ae81ff">2012</span>,
         year_effect <span style="color:#f92672">=</span> <span style="color:#a6e22e">rnorm</span>(n_people, mean <span style="color:#f92672">=</span> <span style="color:#ae81ff">-2</span>, sd <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.1</span>) <span style="color:#f92672">*</span> year_smaller,
         <span style="color:#75715e"># Using a net causes a decrease of 10 points, on average. Again, rather</span>
         <span style="color:#75715e"># than use exactly 10, we&#39;ll use a distribution around 10. People only</span>
         <span style="color:#75715e"># get a net boost if they&#39;re in City B after 2017.</span>
         net_effect <span style="color:#f92672">=</span> <span style="color:#a6e22e">ifelse</span>(city <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;City B&#34;</span> <span style="color:#f92672">&amp;</span> year <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">2017</span>,
                             <span style="color:#a6e22e">rnorm</span>(n_people, mean <span style="color:#f92672">=</span> <span style="color:#ae81ff">-10</span>, sd <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.5</span>),
                             <span style="color:#ae81ff">0</span>),
         <span style="color:#75715e"># Finally combine all these effects to create the malaria risk variable</span>
         malaria_risk <span style="color:#f92672">=</span> malaria_risk_base <span style="color:#f92672">+</span> city_effect <span style="color:#f92672">+</span> year_effect <span style="color:#f92672">+</span> net_effect,
         <span style="color:#75715e"># Rescale so it doesn&#39;t go below 0 or above 100</span>
         malaria_risk <span style="color:#f92672">=</span> <span style="color:#a6e22e">rescale</span>(malaria_risk, to <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">100</span>))) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Make an indicator variable showing if the row is after 2017</span>
  <span style="color:#a6e22e">mutate</span>(after <span style="color:#f92672">=</span> year <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">2017</span>)
   
<span style="color:#a6e22e">head</span>(did_data)
<span style="color:#75715e">## # A tibble: 6 x 11</span>
<span style="color:#75715e">##      id  year city   net   malaria_risk_base city_effect year_smaller year_effect net_effect malaria_risk after</span>
<span style="color:#75715e">##   &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;  &lt;lgl&gt;             &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;      &lt;dbl&gt;        &lt;dbl&gt; &lt;lgl&gt;</span>
<span style="color:#75715e">## 1     1  2014 City B FALSE              53.0        6.25            2       -3.97          0         54.2 FALSE</span>
<span style="color:#75715e">## 2     2  2017 City B FALSE              89.7        3.32            5       -9.17          0         84.1 FALSE</span>
<span style="color:#75715e">## 3     3  2017 City A FALSE              49.5        0               5      -10.1           0         37.6 FALSE</span>
<span style="color:#75715e">## 4     4  2017 City B FALSE              37.4        7.11            5       -9.44          0         33.1 FALSE</span>
<span style="color:#75715e">## 5     5  2019 City A FALSE              76.6        0               7      -14.7           0         61.1 TRUE </span>
<span style="color:#75715e">## 6     6  2017 City B FALSE              65.7        5.38            5      -10.4           0         59.9 FALSE</span>
</code></pre></div></li>
<li>
<p><strong>Verify all relationships with plots and models.</strong></p>
<p>Is risk higher in City B? Yep.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">ggplot</span>(did_data, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> city, y <span style="color:#f92672">=</span> malaria_risk, color <span style="color:#f92672">=</span> city)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">stat_summary</span>(geom <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;pointrange&#34;</span>, fun.data <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;mean_se&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">guides</span>(color <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>)
</code></pre></div><p><img src="/example/synthetic-data_files/figure-html/check-risk-increase-1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Does risk decrease over time? And are the trends parallel? There was a weird random spike in City B in 2017 for whatever reason, but in general, the trends in the two cities are pretty parallel from 2013 to 2017.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">plot_data <span style="color:#f92672">&lt;-</span> did_data <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">group_by</span>(year, city) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">summarize</span>(mean_risk <span style="color:#f92672">=</span> <span style="color:#a6e22e">mean</span>(malaria_risk),
            se_risk <span style="color:#f92672">=</span> <span style="color:#a6e22e">sd</span>(malaria_risk) <span style="color:#f92672">/</span> <span style="color:#a6e22e">sqrt</span>(<span style="color:#a6e22e">n</span>()),
            upper <span style="color:#f92672">=</span> mean_risk <span style="color:#f92672">+</span> (<span style="color:#ae81ff">1.96</span> <span style="color:#f92672">*</span> se_risk),
            lower <span style="color:#f92672">=</span> mean_risk <span style="color:#f92672">+</span> (<span style="color:#ae81ff">-1.96</span> <span style="color:#f92672">*</span> se_risk))
   
<span style="color:#a6e22e">ggplot</span>(plot_data, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> year, y <span style="color:#f92672">=</span> mean_risk, color <span style="color:#f92672">=</span> city)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_vline</span>(xintercept <span style="color:#f92672">=</span> <span style="color:#ae81ff">2017.5</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_ribbon</span>(<span style="color:#a6e22e">aes</span>(ymin <span style="color:#f92672">=</span> lower, ymax <span style="color:#f92672">=</span> upper, fill <span style="color:#f92672">=</span> city), alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.3</span>, color <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_line</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme</span>(legend.position <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bottom&#34;</span>)
</code></pre></div><p><img src="/example/synthetic-data_files/figure-html/check-parallel-trends-1.png" width="75%" style="display: block; margin: auto;" /></p>
</li>
<li>
<p><strong>Try it out!</strong></p>
<p>Let&rsquo;s see if it works! For diff-in-diff we need to use this model:</p>
<p>$$
\text{Malaria risk} = \alpha + \beta\ \text{City B} + \gamma\ \text{After 2017} + \delta\ (\text{City B} \times \text{After 2017}) + \varepsilon
$$</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">model_did <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(malaria_risk <span style="color:#f92672">~</span> city <span style="color:#f92672">+</span> after <span style="color:#f92672">+</span> city <span style="color:#f92672">*</span> after, data <span style="color:#f92672">=</span> did_data)
<span style="color:#a6e22e">tidy</span>(model_did)
<span style="color:#75715e">## # A tibble: 4 x 5</span>
<span style="color:#75715e">##   term                 estimate std.error statistic  p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;                   &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)             59.2      0.549    108.   0.      </span>
<span style="color:#75715e">## 2 cityCity B               5.17     0.778      6.64 3.71e-11</span>
<span style="color:#75715e">## 3 afterTRUE               -7.47     0.939     -7.96 2.61e-15</span>
<span style="color:#75715e">## 4 cityCity B:afterTRUE   -10.2      1.32      -7.79 9.67e-15</span>
</code></pre></div><p>It works! Being in City B is associated with a 5-point higher risk on average; being after 2017 is associated with a 7.5-point lower risk on average, and being in City B after 2017 causes risk to drop by −10. The number isn&rsquo;t exactly −10 here, since we rescaled the <code>malaria_risk</code> column a little, but still, it&rsquo;s close. It&rsquo;d probably be a good idea to build in some more noise and noncompliance, since the p-values are really really tiny here, but this is good enough for now.</p>
<p>Here&rsquo;s an obligatory diff-in-diff visualization:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">plot_data <span style="color:#f92672">&lt;-</span> did_data <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">group_by</span>(after, city) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">summarize</span>(mean_risk <span style="color:#f92672">=</span> <span style="color:#a6e22e">mean</span>(malaria_risk),
            se_risk <span style="color:#f92672">=</span> <span style="color:#a6e22e">sd</span>(malaria_risk) <span style="color:#f92672">/</span> <span style="color:#a6e22e">sqrt</span>(<span style="color:#a6e22e">n</span>()),
            upper <span style="color:#f92672">=</span> mean_risk <span style="color:#f92672">+</span> (<span style="color:#ae81ff">1.96</span> <span style="color:#f92672">*</span> se_risk),
            lower <span style="color:#f92672">=</span> mean_risk <span style="color:#f92672">+</span> (<span style="color:#ae81ff">-1.96</span> <span style="color:#f92672">*</span> se_risk))
   
<span style="color:#75715e"># Extract parts of the model results for adding annotations</span>
model_results <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">tidy</span>(model_did)
before_treatment <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">filter</span>(model_results, term <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;(Intercept)&#34;</span>)<span style="color:#f92672">$</span>estimate <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">filter</span>(model_results, term <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;cityCity B&#34;</span>)<span style="color:#f92672">$</span>estimate
diff_diff <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">filter</span>(model_results, term <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;cityCity B:afterTRUE&#34;</span>)<span style="color:#f92672">$</span>estimate
after_treatment <span style="color:#f92672">&lt;-</span> before_treatment <span style="color:#f92672">+</span> diff_diff <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">filter</span>(model_results, term <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;afterTRUE&#34;</span>)<span style="color:#f92672">$</span>estimate
   
<span style="color:#a6e22e">ggplot</span>(plot_data, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> after, y <span style="color:#f92672">=</span> mean_risk, color <span style="color:#f92672">=</span> city, group <span style="color:#f92672">=</span> city)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_pointrange</span>(<span style="color:#a6e22e">aes</span>(ymin <span style="color:#f92672">=</span> lower, ymax <span style="color:#f92672">=</span> upper)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_line</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">annotate</span>(geom <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;segment&#34;</span>, x <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>, xend <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>,
           y <span style="color:#f92672">=</span> before_treatment, yend <span style="color:#f92672">=</span> after_treatment <span style="color:#f92672">-</span> diff_diff,
           linetype <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;dashed&#34;</span>, color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;grey50&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">annotate</span>(geom <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;segment&#34;</span>, x <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.1</span>, xend <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.1</span>,
           y <span style="color:#f92672">=</span> after_treatment, yend <span style="color:#f92672">=</span> after_treatment <span style="color:#f92672">-</span> diff_diff,
           linetype <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;dotted&#34;</span>, color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blue&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme</span>(legend.position <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bottom&#34;</span>)
</code></pre></div><p><img src="/example/synthetic-data_files/figure-html/show-diff-diff-1.png" width="75%" style="display: block; margin: auto;" /></p>
</li>
<li>
<p><strong>Save the data.</strong></p>
<p>The data works, so let&rsquo;s get rid of the intermediate columns we don&rsquo;t need and save it as a CSV file.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">did_data_final <span style="color:#f92672">&lt;-</span> did_data <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">select</span>(id, year, city, net, malaria_risk)
<span style="color:#a6e22e">head</span>(did_data_final)
<span style="color:#75715e">## # A tibble: 6 x 5</span>
<span style="color:#75715e">##      id  year city   net   malaria_risk</span>
<span style="color:#75715e">##   &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;  &lt;lgl&gt;        &lt;dbl&gt;</span>
<span style="color:#75715e">## 1     1  2014 City B FALSE         54.2</span>
<span style="color:#75715e">## 2     2  2017 City B FALSE         84.1</span>
<span style="color:#75715e">## 3     3  2017 City A FALSE         37.6</span>
<span style="color:#75715e">## 4     4  2017 City B FALSE         33.1</span>
<span style="color:#75715e">## 5     5  2019 City A FALSE         61.1</span>
<span style="color:#75715e">## 6     6  2017 City B FALSE         59.9</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Save data</span>
<span style="color:#a6e22e">write_csv</span>(did_data_final, <span style="color:#e6db74">&#34;data/diff_diff.csv&#34;</span>)
</code></pre></div></li>
</ol>
<h3 id="creating-an-effect-for-regression-discontinuity">Creating an effect for regression discontinuity</h3>
<ol>
<li>
<p><strong>Draw a DAG that maps out how all the columns you care about are related.</strong></p>
<p>Regression discontinuity designs are also based on context instead of models, so the DAG is pretty simple. We&rsquo;ll keep with our mosquito net example and pretend that families that earn less than $450 a week qualify for a free net. Here&rsquo;s the DAG:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">rdd_dag <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dagify</span>(mal <span style="color:#f92672">~</span> net <span style="color:#f92672">+</span> inc,
                  net <span style="color:#f92672">~</span> cut,
                  cut <span style="color:#f92672">~</span> inc,
                  coords <span style="color:#f92672">=</span> <span style="color:#a6e22e">list</span>(x <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(mal <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>, net <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, inc <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, cut <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>),
                                y <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(mal <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, net <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, inc <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, cut <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.75</span>)))
<span style="color:#a6e22e">ggdag</span>(rdd_dag) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme_dag</span>()
</code></pre></div><p><img src="/example/synthetic-data_files/figure-html/rdd-dag-1.png" width="75%" style="display: block; margin: auto;" /></p>
</li>
<li>
<p><strong>Specify how those nodes are measured.</strong></p>
<p>Here&rsquo;s how we&rsquo;ll measure these nodes:</p>
<ul>
<li>
<p><strong>Malaria risk</strong>: scale from 0–100, mostly around 60, but ranging from 30ish to 90ish. Best to use a Beta distribution.</p>
</li>
<li>
<p><strong>Net use</strong>: binary 0/1, TRUE/FALSE variable. This is technically binomial, but we don&rsquo;t need to simulate it since it will only happen for people who below the cutoff.</p>
</li>
<li>
<p><strong>Income</strong>: weekly income, measured in dollars, mostly around 500 ± 300. Best to use a normal distribution.</p>
</li>
<li>
<p><strong>Cutoff</strong>: binary 0/1, below/above $450 variable. This is technically binomial, but we don&rsquo;t need to simulate it since it is entirely based on income.</p>
</li>
</ul>
</li>
<li>
<p><strong>Specify the relationships between the nodes based on the DAG equations.</strong></p>
<p>There are three models in the DAG:</p>
<ul>
<li>
<p><strong><code>cut ~ inc</code></strong>: Being above or below the cutpoint is determined by income. We know the cutoff is 450, so we just make an indicator showing if people are below that.</p>
</li>
<li>
<p><strong><code>net ~ cut</code></strong>: Net usage is determined by the cutpoint. If people are below the cutpoint, they&rsquo;ll use a net; if not, they won&rsquo;t. We can build in noncompliance here if we want and use fuzzy regression discontinuity. For the sake of this example, we&rsquo;ll do it both ways, just so you can see both sharp and fuzzy synthetic data.</p>
</li>
<li>
<p><strong><code>mal ~ net + inc</code></strong>: Malaria risk is determined by both net usage and income. It&rsquo;s also determined by lots of other things (age, education, city, etc.), but we don&rsquo;t need to include those in the DAG because we&rsquo;re using RDD to say that we have good treatment and control groups right around the cutoff.</p>
<p>We&rsquo;ll pretend that a 1 dollar increase in income is associated with a drop in risk of 0.01, and that using a mosquito net causes a decrease of 10 points on average. That&rsquo;s our causal effect.</p>
</li>
</ul>
</li>
<li>
<p><strong>Generate random columns that stand alone. Generate related columns using regression math. Consider adding random noise. This is an entirely trial and error process until you get numbers that look good. Rely <em>heavily</em> on plots as you try different coefficients and parameters. Optionally rescale any columns that go out of reasonable bounds. If you rescale, you&rsquo;ll need to tinker with the coefficients you used since the final effects will also get rescaled.</strong></p>
<p>Let&rsquo;s fake some data! Heavily annotated code below:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Make this randomness consistent</span>
<span style="color:#a6e22e">set.seed</span>(<span style="color:#ae81ff">1234</span>)
   
<span style="color:#75715e"># Simulate 5441 people (we need a lot bc we&#39;re throwing most away)</span>
n_people <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">5441</span>
   
rdd_data <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">tibble</span>(
  <span style="color:#75715e"># Make an ID column (not necessary, but nice to have)</span>
  id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>n_people,
  <span style="color:#75715e"># Generate income variable: normal, 500 ± 300</span>
  income <span style="color:#f92672">=</span> <span style="color:#a6e22e">rnorm</span>(n_people, mean <span style="color:#f92672">=</span> <span style="color:#ae81ff">500</span>, sd <span style="color:#f92672">=</span> <span style="color:#ae81ff">75</span>)
) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Generate cutoff variable</span>
  <span style="color:#a6e22e">mutate</span>(below_cutoff <span style="color:#f92672">=</span> <span style="color:#a6e22e">ifelse</span>(income <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">450</span>, <span style="color:#66d9ef">TRUE</span>, <span style="color:#66d9ef">FALSE</span>)) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Generate net variable. We&#39;ll make two: one that&#39;s sharp and has perfect</span>
  <span style="color:#75715e"># compliance, and one that&#39;s fuzzy</span>
  <span style="color:#75715e"># Here&#39;s the sharp one. It&#39;s easy. If you&#39;re below the cutoff you use a net.</span>
  <span style="color:#a6e22e">mutate</span>(net_sharp <span style="color:#f92672">=</span> <span style="color:#a6e22e">ifelse</span>(below_cutoff <span style="color:#f92672">==</span> <span style="color:#66d9ef">TRUE</span>, <span style="color:#66d9ef">TRUE</span>, <span style="color:#66d9ef">FALSE</span>)) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Here&#39;s the fuzzy one, which is a little trickier. If you&#39;re far away from</span>
  <span style="color:#75715e"># the cutoff, you follow what you&#39;re supposed to do (like if your income is</span>
  <span style="color:#75715e"># 800, you don&#39;t use the program; if your income is 200, you definitely use</span>
  <span style="color:#75715e"># the program). But if you&#39;re close to the cutoff, we&#39;ll pretend that there&#39;s</span>
  <span style="color:#75715e"># an 80% chance that you&#39;ll do what you&#39;re supposed to do.</span>
  <span style="color:#a6e22e">mutate</span>(net_fuzzy <span style="color:#f92672">=</span> <span style="color:#a6e22e">case_when</span>(
    <span style="color:#75715e"># If your income is between 450 and 500, there&#39;s a 20% chance of using the program</span>
    income <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">450</span> <span style="color:#f92672">&amp;</span> income <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">500</span> <span style="color:#f92672">~</span> <span style="color:#a6e22e">sample</span>(<span style="color:#a6e22e">c</span>(<span style="color:#66d9ef">TRUE</span>, <span style="color:#66d9ef">FALSE</span>), n_people, replace <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>, prob <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0.2</span>, <span style="color:#ae81ff">0.8</span>)),
    <span style="color:#75715e"># If your income is above 500, you definitely don&#39;t use the program</span>
    income <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">500</span> <span style="color:#f92672">~</span> <span style="color:#66d9ef">FALSE</span>,
    <span style="color:#75715e"># If your income is between 400 and 450, there&#39;s an 80% chance of using the program</span>
    income <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">450</span> <span style="color:#f92672">&amp;</span> income <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">400</span> <span style="color:#f92672">~</span> <span style="color:#a6e22e">sample</span>(<span style="color:#a6e22e">c</span>(<span style="color:#66d9ef">TRUE</span>, <span style="color:#66d9ef">FALSE</span>), n_people, replace <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>, prob <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0.8</span>, <span style="color:#ae81ff">0.2</span>)),
    <span style="color:#75715e"># If your income is below 400, you definitely use the program</span>
    income <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">400</span> <span style="color:#f92672">~</span> <span style="color:#66d9ef">TRUE</span>
  )) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Finally we can make the malaria risk score, based on income, net use, and</span>
  <span style="color:#75715e"># random noise. We&#39;ll make two outcomes: one using the sharp net use and one</span>
  <span style="color:#75715e"># using the fuzzy net use. They have the same effect built in, we just have to</span>
  <span style="color:#75715e"># use net_sharp and net_fuzzy separately.</span>
  <span style="color:#a6e22e">mutate</span>(malaria_risk_base <span style="color:#f92672">=</span> <span style="color:#a6e22e">rbeta</span>(n_people, shape1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>, shape2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">100</span>) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Make the sharp version. There&#39;s really a 10 point decrease, but because of</span>
  <span style="color:#75715e"># rescaling, we use 15. I only chose 15 through lots of trial and error (i.e.</span>
  <span style="color:#75715e"># I used -11, ran the RDD model, and the effect was too small; I used -20, ran</span>
  <span style="color:#75715e"># the model, and the effect was too big; I kept changing numbers until landing</span>
  <span style="color:#75715e"># on -15). Risk also goes down as income increases.</span>
  <span style="color:#a6e22e">mutate</span>(malaria_effect_sharp <span style="color:#f92672">=</span> (<span style="color:#ae81ff">-15</span> <span style="color:#f92672">*</span> net_sharp) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">-0.01</span> <span style="color:#f92672">*</span> income),
         malaria_risk_sharp <span style="color:#f92672">=</span> malaria_risk_base <span style="color:#f92672">+</span> malaria_effect_sharp <span style="color:#f92672">+</span> <span style="color:#a6e22e">rnorm</span>(n_people, <span style="color:#ae81ff">0</span>, sd <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>),
         malaria_risk_sharp <span style="color:#f92672">=</span> <span style="color:#a6e22e">rescale</span>(malaria_risk_sharp, to <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">70</span>))) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Do the same thing, but with net_fuzzy</span>
  <span style="color:#a6e22e">mutate</span>(malaria_effect_fuzzy <span style="color:#f92672">=</span> (<span style="color:#ae81ff">-15</span> <span style="color:#f92672">*</span> net_fuzzy) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">-0.01</span> <span style="color:#f92672">*</span> income),
         malaria_risk_fuzzy <span style="color:#f92672">=</span> malaria_risk_base <span style="color:#f92672">+</span> malaria_effect_fuzzy <span style="color:#f92672">+</span> <span style="color:#a6e22e">rnorm</span>(n_people, <span style="color:#ae81ff">0</span>, sd <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>),
         malaria_risk_fuzzy <span style="color:#f92672">=</span> <span style="color:#a6e22e">rescale</span>(malaria_risk_fuzzy, to <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">70</span>))) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Make a version of income that&#39;s centered at the cutpoint</span>
  <span style="color:#a6e22e">mutate</span>(income_centered <span style="color:#f92672">=</span> income <span style="color:#f92672">-</span> <span style="color:#ae81ff">450</span>)
   
<span style="color:#a6e22e">head</span>(rdd_data)
<span style="color:#75715e">## # A tibble: 6 x 11</span>
<span style="color:#75715e">##      id income below_cutoff net_sharp net_fuzzy malaria_risk_base malaria_effect_sharp malaria_risk_sharp malaria_effect_fuzzy malaria_risk_fuzzy income_centered</span>
<span style="color:#75715e">##   &lt;int&gt;  &lt;dbl&gt; &lt;lgl&gt;        &lt;lgl&gt;     &lt;lgl&gt;                 &lt;dbl&gt;                &lt;dbl&gt;              &lt;dbl&gt;                &lt;dbl&gt;              &lt;dbl&gt;           &lt;dbl&gt;</span>
<span style="color:#75715e">## 1     1   409. TRUE         TRUE      FALSE                  56.5               -19.1                38.0                -4.09               47.5           -40.5</span>
<span style="color:#75715e">## 2     2   521. FALSE        FALSE     FALSE                  26.1                -5.21               28.6                -5.21               27.6            70.8</span>
<span style="color:#75715e">## 3     3   581. FALSE        FALSE     FALSE                  84.4                -5.81               64.7                -5.81               65.5           131. </span>
<span style="color:#75715e">## 4     4   324. TRUE         TRUE      TRUE                   32.9               -18.2                25.9               -18.2                23.4          -126. </span>
<span style="color:#75715e">## 5     5   532. FALSE        FALSE     FALSE                  53.1                -5.32               46.5                -5.32               44.3            82.2</span>
<span style="color:#75715e">## 6     6   538. FALSE        FALSE     FALSE                  45.7                -5.38               43.2                -5.38               40.2            88.0</span>
</code></pre></div></li>
<li>
<p><strong>Verify all relationships with plots and models.</strong></p>
<p>Is there a cutoff in the running variable when we use the sharp net variable? Yep!</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">ggplot</span>(rdd_data, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> income, y <span style="color:#f92672">=</span> net_sharp, color <span style="color:#f92672">=</span> below_cutoff)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_vline</span>(xintercept <span style="color:#f92672">=</span> <span style="color:#ae81ff">450</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_point</span>(alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.3</span>, position <span style="color:#f92672">=</span> <span style="color:#a6e22e">position_jitter</span>(width <span style="color:#f92672">=</span> <span style="color:#66d9ef">NULL</span>, height <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.2</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">guides</span>(color <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>)
</code></pre></div><p><img src="/example/synthetic-data_files/figure-html/sharp-running-var-cutoff-1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Is there a cutoff in the running variable when we use the fuzzy net variable? Yep! There are some richer people using the program and some poorer people not using it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">ggplot</span>(rdd_data, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> income, y <span style="color:#f92672">=</span> net_fuzzy, color <span style="color:#f92672">=</span> below_cutoff)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_vline</span>(xintercept <span style="color:#f92672">=</span> <span style="color:#ae81ff">450</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_point</span>(alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.3</span>, position <span style="color:#f92672">=</span> <span style="color:#a6e22e">position_jitter</span>(width <span style="color:#f92672">=</span> <span style="color:#66d9ef">NULL</span>, height <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.2</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">guides</span>(color <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>)
</code></pre></div><p><img src="/example/synthetic-data_files/figure-html/fuzzy-running-var-cutoff-1.png" width="75%" style="display: block; margin: auto;" /></p>
</li>
<li>
<p><strong>Try it out!</strong></p>
<p>Let&rsquo;s test it! For sharp RDD we need to use this model:</p>
<p>$$
\text{Malaria risk} = \beta_0 + \beta_1 \text{Income}_\text{centered} + \beta_2 \text{Net} + \varepsilon
$$</p>
<p>We&rsquo;ll use a bandwidth of ±$50, because why not. In real life you&rsquo;d be more careful about bandwidth selection (or use <code>rdbwselect()</code> from the <strong>rdrobust</strong> package to find the optimal bandwidth)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">ggplot</span>(rdd_data, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> income, y <span style="color:#f92672">=</span> malaria_risk_sharp, color <span style="color:#f92672">=</span> net_sharp)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_vline</span>(xintercept <span style="color:#f92672">=</span> <span style="color:#ae81ff">450</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_point</span>(alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.2</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.5</span>) <span style="color:#f92672">+</span>
  <span style="color:#75715e"># Add lines for the full range</span>
  <span style="color:#a6e22e">geom_smooth</span>(data <span style="color:#f92672">=</span> <span style="color:#a6e22e">filter</span>(rdd_data, income_centered <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>),
              method <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;lm&#34;</span>, se <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, linetype <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;dashed&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_smooth</span>(data <span style="color:#f92672">=</span> <span style="color:#a6e22e">filter</span>(rdd_data, income_centered <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>),
              method <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;lm&#34;</span>, se <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, linetype <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;dashed&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#75715e"># Add lines for bandwidth = 50</span>
  <span style="color:#a6e22e">geom_smooth</span>(data <span style="color:#f92672">=</span> <span style="color:#a6e22e">filter</span>(rdd_data, income_centered <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">-50</span> <span style="color:#f92672">&amp;</span> income_centered <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>),
              method <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;lm&#34;</span>, se <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_smooth</span>(data <span style="color:#f92672">=</span> <span style="color:#a6e22e">filter</span>(rdd_data, income_centered <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;</span> income_centered <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">50</span>),
              method <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;lm&#34;</span>, se <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme</span>(legend.position <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bottom&#34;</span>)
</code></pre></div><p><img src="/example/synthetic-data_files/figure-html/sharp-results-1.png" width="75%" style="display: block; margin: auto;" /></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">model_sharp <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(malaria_risk_sharp <span style="color:#f92672">~</span> income_centered <span style="color:#f92672">+</span> net_sharp,
                  data <span style="color:#f92672">=</span> <span style="color:#a6e22e">filter</span>(rdd_data,
                                income_centered <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">-50</span> <span style="color:#f92672">&amp;</span> income_centered <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">50</span>))
<span style="color:#a6e22e">tidy</span>(model_sharp)
<span style="color:#75715e">## # A tibble: 3 x 5</span>
<span style="color:#75715e">##   term            estimate std.error statistic  p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;              &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)      40.7       0.462      88.1  0.      </span>
<span style="color:#75715e">## 2 income_centered  -0.0197    0.0144     -1.37 1.72e- 1</span>
<span style="color:#75715e">## 3 net_sharpTRUE   -10.6       0.815     -13.0  1.67e-37</span>
</code></pre></div><p>There&rsquo;s an effect! For people in the bandwidth, the local average treatment effect of nets is a 10.6 point reduction in malaria risk.</p>
<p>Let&rsquo;s check if it works with the fuzzy version where there are noncompliers:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">ggplot</span>(rdd_data, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> income, y <span style="color:#f92672">=</span> malaria_risk_fuzzy, color <span style="color:#f92672">=</span> net_fuzzy)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_vline</span>(xintercept <span style="color:#f92672">=</span> <span style="color:#ae81ff">450</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_point</span>(alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.2</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.5</span>) <span style="color:#f92672">+</span>
  <span style="color:#75715e"># Add lines for the full range</span>
  <span style="color:#a6e22e">geom_smooth</span>(data <span style="color:#f92672">=</span> <span style="color:#a6e22e">filter</span>(rdd_data, income_centered <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>),
              method <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;lm&#34;</span>, se <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, linetype <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;dashed&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_smooth</span>(data <span style="color:#f92672">=</span> <span style="color:#a6e22e">filter</span>(rdd_data, income_centered <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>),
              method <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;lm&#34;</span>, se <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, linetype <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;dashed&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#75715e"># Add lines for bandwidth = 50</span>
  <span style="color:#a6e22e">geom_smooth</span>(data <span style="color:#f92672">=</span> <span style="color:#a6e22e">filter</span>(rdd_data, income_centered <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">-50</span> <span style="color:#f92672">&amp;</span> income_centered <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>),
              method <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;lm&#34;</span>, se <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_smooth</span>(data <span style="color:#f92672">=</span> <span style="color:#a6e22e">filter</span>(rdd_data, income_centered <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;</span> income_centered <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">50</span>),
              method <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;lm&#34;</span>, se <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme</span>(legend.position <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bottom&#34;</span>)
</code></pre></div><p><img src="/example/synthetic-data_files/figure-html/fuzzy-results-1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>There&rsquo;s a gap, but it&rsquo;s hard to measure since there are noncompliers on both sides. We can deal with the noncompliance if we use above/below the cutoff as an instrument (see the <a href="/example/rdd-fuzzy/">fuzzy regression discontinuity guide</a> for a complete example). We should run this set of models:</p>
<p>$$
\begin{aligned}
\widehat{\text{Net}} &amp;= \gamma_0 + \gamma_1 \text{Income}_{\text{centered}} + \gamma_2 \text{Below 450} + \omega \\<br>
\text{Malaria risk} &amp;= \beta_0 + \beta_1 \text{Income}_{\text{centered}} + \beta_2 \widehat{\text{Net}} + \epsilon
\end{aligned}
$$</p>
<p>Instead of doing these two stages by hand (ugh), we&rsquo;ll do the 2SLS regression with the <code>iv_robust()</code> function from the <strong>estimatr</strong> package:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">library</span>(estimatr)
   
model_fuzzy <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">iv_robust</span>(malaria_risk_fuzzy <span style="color:#f92672">~</span> income_centered <span style="color:#f92672">+</span> net_fuzzy <span style="color:#f92672">|</span>
                           income_centered <span style="color:#f92672">+</span> below_cutoff,
                         data <span style="color:#f92672">=</span> <span style="color:#a6e22e">filter</span>(rdd_data,
                                       income_centered <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">-50</span> <span style="color:#f92672">&amp;</span> income_centered <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">50</span>))
<span style="color:#a6e22e">tidy</span>(model_fuzzy)
<span style="color:#75715e">##              term  estimate std.error statistic   p.value  conf.low conf.high   df            outcome</span>
<span style="color:#75715e">## 1     (Intercept)  40.73241   0.69045    58.994 0.000e+00  39.37843 42.086402 2220 malaria_risk_fuzzy</span>
<span style="color:#75715e">## 2 income_centered  -0.01921   0.01423    -1.350 1.772e-01  -0.04711  0.008696 2220 malaria_risk_fuzzy</span>
<span style="color:#75715e">## 3   net_fuzzyTRUE -11.21929   1.31033    -8.562 2.034e-17 -13.78889 -8.649700 2220 malaria_risk_fuzzy</span>
</code></pre></div><p>The effect is slightly larger now (−11.2), but that&rsquo;s because we are looking at a doubly local ATE: compliers in the bandwidth. But still, it&rsquo;s close to −10, so that&rsquo;s good. And we could probably get it closer if we did other mathy shenanigans like adding squared and cubed terms or using nonparametric estimation with <code>rdrobust()</code> in the <strong>rdrobust</strong> package.</p>
</li>
<li>
<p><strong>Save the data.</strong></p>
<p>The data works, so let&rsquo;s get rid of the intermediate columns we don&rsquo;t need and save it as a CSV file. We&rsquo;ll make two separate CSV files for fuzzy and sharp, just because.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">rdd_data_final_sharp <span style="color:#f92672">&lt;-</span> rdd_data <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">select</span>(id, income, net <span style="color:#f92672">=</span> net_sharp, malaria_risk <span style="color:#f92672">=</span> malaria_risk_sharp)
<span style="color:#a6e22e">head</span>(rdd_data_final_sharp)
<span style="color:#75715e">## # A tibble: 6 x 4</span>
<span style="color:#75715e">##      id income net   malaria_risk</span>
<span style="color:#75715e">##   &lt;int&gt;  &lt;dbl&gt; &lt;lgl&gt;        &lt;dbl&gt;</span>
<span style="color:#75715e">## 1     1   409. TRUE          38.0</span>
<span style="color:#75715e">## 2     2   521. FALSE         28.6</span>
<span style="color:#75715e">## 3     3   581. FALSE         64.7</span>
<span style="color:#75715e">## 4     4   324. TRUE          25.9</span>
<span style="color:#75715e">## 5     5   532. FALSE         46.5</span>
<span style="color:#75715e">## 6     6   538. FALSE         43.2</span>
   
rdd_data_final_fuzzy <span style="color:#f92672">&lt;-</span> rdd_data <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">select</span>(id, income, net <span style="color:#f92672">=</span> net_fuzzy, malaria_risk <span style="color:#f92672">=</span> malaria_risk_fuzzy)
<span style="color:#a6e22e">head</span>(rdd_data_final_fuzzy)
<span style="color:#75715e">## # A tibble: 6 x 4</span>
<span style="color:#75715e">##      id income net   malaria_risk</span>
<span style="color:#75715e">##   &lt;int&gt;  &lt;dbl&gt; &lt;lgl&gt;        &lt;dbl&gt;</span>
<span style="color:#75715e">## 1     1   409. FALSE         47.5</span>
<span style="color:#75715e">## 2     2   521. FALSE         27.6</span>
<span style="color:#75715e">## 3     3   581. FALSE         65.5</span>
<span style="color:#75715e">## 4     4   324. TRUE          23.4</span>
<span style="color:#75715e">## 5     5   532. FALSE         44.3</span>
<span style="color:#75715e">## 6     6   538. FALSE         40.2</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Save data</span>
<span style="color:#a6e22e">write_csv</span>(rdd_data_final_sharp, <span style="color:#e6db74">&#34;data/rdd_sharp.csv&#34;</span>)
<span style="color:#a6e22e">write_csv</span>(rdd_data_final_fuzzy, <span style="color:#e6db74">&#34;data/rdd_fuzzy.csv&#34;</span>)
</code></pre></div></li>
</ol>
<h3 id="creating-an-effect-for-instrumental-variables">Creating an effect for instrumental variables</h3>
<ol>
<li>
<p><strong>Draw a DAG that maps out how all the columns you care about are related.</strong></p>
<p>As with diff-in-diff and regression discontinuity, instrumental variables are a design-based approach to causal inference and thus don&rsquo;t require complicated models (but you can still add control variables!), so their DAGs are simpler. Once again we&rsquo;ll look at the effect of mosquito nets on malaria risk, but this time we&rsquo;ll say that we cannot possibly measure all the confounding factors between net use and malaria risk, so we&rsquo;ll use an instrument to extract the exogeneity from net use.</p>
<p><a href="/content/11-content/">As we talked about in Session 11</a>, good plausible instruments are hard to find: they have to cause bed net use and <em>not</em> be related to malaria risk <em>except through</em> bed net use.</p>
<p>For this example, we&rsquo;ll pretend that free bed nets are distributed from town halls around the country. We&rsquo;ll use &ldquo;distance to town hall&rdquo; as our instrument, since it could arguably maybe work perhaps. Being closer to a town hall makes you more likely to use a net, but being closer to a town halls doesn&rsquo;t make put you at higher or lower risk for malaria on its own—it does that only because it changes your likelihood of getting a net.</p>
<p>This is where the story for the instrument falls apart, actually; in real life, if you live far away from a town hall, you probably live further from health services and live in more rural places with worse mosquito abatement policies, so you&rsquo;re probably at higher risk of malaria. It&rsquo;s probably a bad instrument, but just go with it.</p>
<p>Here&rsquo;s the DAG:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">iv_dag <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dagify</span>(mal <span style="color:#f92672">~</span> net <span style="color:#f92672">+</span> U,
                 net <span style="color:#f92672">~</span> dist <span style="color:#f92672">+</span> U,
                 coords <span style="color:#f92672">=</span> <span style="color:#a6e22e">list</span>(x <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(mal <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>, net <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, U <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, dist <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>),
                               y <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(mal <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, net <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, U <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, dist <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.5</span>)),
                 latent <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;U&#34;</span>)
   
<span style="color:#a6e22e">ggdag_status</span>(iv_dag) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">guides</span>(color <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme_dag</span>()
</code></pre></div><p><img src="/example/synthetic-data_files/figure-html/iv-dag-1.png" width="75%" style="display: block; margin: auto;" /></p>
</li>
<li>
<p><strong>Specify how those nodes are measured.</strong></p>
<p>Here&rsquo;s how we&rsquo;ll measure these nodes:</p>
<ul>
<li>
<p><strong>Malaria risk</strong>: scale from 0–100, mostly around 60, but ranging from 30ish to 90ish. Best to use a Beta distribution.</p>
</li>
<li>
<p><strong>Net use</strong>: binary 0/1, TRUE/FALSE variable. However, since we want to use other variables that increase the likelihood of using a net, we&rsquo;ll do some cool tricky stuff with a bed net score, like we did in the observational DAG example earlier.</p>
</li>
<li>
<p><strong>Distance</strong>: distance to nearest town hall, measured in kilometers, mostly around 3, with a left skewed long tail (i.e. most people live fairly close, some people live far away). Best to use a Beta distribution (to get the skewed shape) that we then rescale.</p>
</li>
<li>
<p><strong>Unobserved</strong>: who knows?! There are a lot of unknown confounders. We could generate columns like income, age, education, and health, make them mathematically related to malaria risk and net use, and then throw those columns away in the final data so they&rsquo;re unobserved. That would be fairly easy and intuitive.</p>
<p>For the sake of simplicity here, we&rsquo;ll make a column called &ldquo;risk factors,&rdquo; kind of like we did with the &ldquo;ability&rdquo; column in <a href="https://evalf20.classes.andrewheiss.com/example/iv/#education-wages-and-fathers-education-fake-data" target="_blank" rel="noopener">the instrumental variables example</a>—it&rsquo;s a magical column that is unmeasurable, but it&rsquo;ll open a backdoor path between net use and malaria risk and thus create endogeneity. It&rsquo;ll be normally distributed around 50, with a standard deviation of 25.</p>
</li>
</ul>
</li>
<li>
<p><strong>Specify the relationships between the nodes based on the DAG equations.</strong></p>
<p>There are two models in the DAG:</p>
<ul>
<li>
<p><strong><code>net ~ dist + U</code></strong>: Net usage is determined by both distance and our magical unobserved risk factor column. Net use is technically binomial, but in order to change the likelihood of net use based on distance to town hall and unobserved stuff, we&rsquo;ll do the fancy tricky stuff we did in the observational DAG section above: we&rsquo;ll create a bed net score, increase or decrease that score based on risk factors and distance, scale that score to a 0-1 scale of probabilities, and then draw a binomial 0/1 outcome using those probabilities.</p>
<p>We&rsquo;ll say that a one kilometer increase in the distance to a town halls reduces the bed net score and a one point increase in risk factors reduces the bed net score.</p>
</li>
<li>
<p><strong><code>mal ~ net + U</code></strong>: Malaria risk is determined by both net usage and unkown stuff, or the magical column we&rsquo;re calling &ldquo;risk factors.&rdquo; We&rsquo;ll say that a one point increase in risk factors increases malaria risk, and that using a mosquito net causes a decrease of 10 points on average. That&rsquo;s our causal effect.</p>
</li>
</ul>
</li>
<li>
<p><strong>Generate random columns that stand alone. Generate related columns using regression math. Consider adding random noise. This is an entirely trial and error process until you get numbers that look good. Rely <em>heavily</em> on plots as you try different coefficients and parameters. Optionally rescale any columns that go out of reasonable bounds. If you rescale, you&rsquo;ll need to tinker with the coefficients you used since the final effects will also get rescaled.</strong></p>
<p>Fake data time! Here&rsquo;s some heavily annotated code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Make this randomness consistent</span>
<span style="color:#a6e22e">set.seed</span>(<span style="color:#ae81ff">1234</span>)
   
<span style="color:#75715e"># Simulate 1578 people (just for fun)</span>
n_people <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1578</span>
   
iv_data <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">tibble</span>(
  <span style="color:#75715e"># Make an ID column (not necessary, but nice to have)</span>
  id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>n_people,
  <span style="color:#75715e"># Generate magical unobserved risk factor variable: normal, 500 ± 300</span>
  risk_factors <span style="color:#f92672">=</span> <span style="color:#a6e22e">rnorm</span>(n_people, mean <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>, sd <span style="color:#f92672">=</span> <span style="color:#ae81ff">25</span>),
  <span style="color:#75715e"># Generate distance to town hall variable</span>
  distance <span style="color:#f92672">=</span> <span style="color:#a6e22e">rbeta</span>(n_people, shape1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, shape2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>)
) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Scale up distance to be 0.1-15 instead of 0-1</span>
  <span style="color:#a6e22e">mutate</span>(distance <span style="color:#f92672">=</span> <span style="color:#a6e22e">rescale</span>(distance, to <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0.1</span>, <span style="color:#ae81ff">15</span>))) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Generate net variable based on distance, risk factors, and random noise</span>
  <span style="color:#75715e"># Note: These -40 and -2 effects are entirely made up and I got them through a</span>
  <span style="color:#75715e"># lot of trial and error and rerunning this stupid chunk dozens of times</span>
  <span style="color:#a6e22e">mutate</span>(net_score <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">+</span>
           (<span style="color:#ae81ff">-40</span> <span style="color:#f92672">*</span> distance) <span style="color:#f92672">+</span>  <span style="color:#75715e"># Distance effect</span>
           (<span style="color:#ae81ff">-2</span> <span style="color:#f92672">*</span> risk_factors) <span style="color:#f92672">+</span>  <span style="color:#75715e"># Risk factor effect</span>
           <span style="color:#a6e22e">rnorm</span>(n_people, mean <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, sd <span style="color:#f92672">=</span> <span style="color:#ae81ff">50</span>),  <span style="color:#75715e"># Random noise</span>
        net_probability <span style="color:#f92672">=</span> <span style="color:#a6e22e">rescale</span>(net_score, to <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0.15</span>, <span style="color:#ae81ff">1</span>)),
        <span style="color:#75715e"># Randomly generate a 0/1 variable using that probability</span>
        net <span style="color:#f92672">=</span> <span style="color:#a6e22e">rbinom</span>(n_people, <span style="color:#ae81ff">1</span>, net_probability)) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Generate malaria risk variable based on net use, risk factors, and random noise</span>
  <span style="color:#a6e22e">mutate</span>(malaria_risk_base <span style="color:#f92672">=</span> <span style="color:#a6e22e">rbeta</span>(n_people, shape1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>, shape2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">100</span>,
         <span style="color:#75715e"># We&#39;re aiming for a -10 net effect, but need to boost it because of rescaling</span>
         malaria_effect <span style="color:#f92672">=</span> (<span style="color:#ae81ff">-20</span> <span style="color:#f92672">*</span> net) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">0.5</span> <span style="color:#f92672">*</span> risk_factors),
         <span style="color:#75715e"># Make the final malaria risk score</span>
         malaria_risk <span style="color:#f92672">=</span> malaria_risk_base <span style="color:#f92672">+</span> malaria_effect,
         <span style="color:#75715e"># Rescale so it doesn&#39;t go below 0</span>
         malaria_risk <span style="color:#f92672">=</span> <span style="color:#a6e22e">rescale</span>(malaria_risk, to <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">80</span>)))
iv_data
<span style="color:#75715e">## # A tibble: 1,578 x 9</span>
<span style="color:#75715e">##       id risk_factors distance net_score net_probability   net malaria_risk_base malaria_effect malaria_risk</span>
<span style="color:#75715e">##    &lt;int&gt;        &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;           &lt;dbl&gt; &lt;int&gt;             &lt;dbl&gt;          &lt;dbl&gt;        &lt;dbl&gt;</span>
<span style="color:#75715e">##  1     1         69.8    3.98      -202.           0.766     1              71.1           14.9         36.5</span>
<span style="color:#75715e">##  2     2        107.     2.14      -284.           0.686     1              75.4           33.5         49.5</span>
<span style="color:#75715e">##  3     3        127.     5.47      -469.           0.505     0              57.4           63.6         56.4</span>
<span style="color:#75715e">##  4     4         41.4    9.61      -414.           0.558     0              37.2           20.7         20.4</span>
<span style="color:#75715e">##  5     5        111.     4.66      -376.           0.596     0              38.5           55.4         40.9</span>
<span style="color:#75715e">##  6     6        113.     2.29      -284.           0.686     1              75.7           36.3         51.3</span>
<span style="color:#75715e">##  7     7         85.6    0.922     -215.           0.753     0              28.7           42.8         28.2</span>
<span style="color:#75715e">##  8     8         86.3   12.5       -608.           0.368     1              50.6           23.2         29.4</span>
<span style="color:#75715e">##  9     9         85.9    3.11      -267.           0.703     1              38.4           22.9         22.4</span>
<span style="color:#75715e">## 10    10         77.7    1.35      -157.           0.810     1              69.1           18.9         37.6</span>
<span style="color:#75715e">## # … with 1,568 more rows</span>
</code></pre></div></li>
<li>
<p><strong>Verify all relationships with plots and models.</strong></p>
<p>Is there a relationship between unobserved risk factors and malaria risk? Yep.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">ggplot</span>(iv_data, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> risk_factors, y <span style="color:#f92672">=</span> malaria_risk)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_point</span>(<span style="color:#a6e22e">aes</span>(color <span style="color:#f92672">=</span> <span style="color:#a6e22e">as.factor</span>(net))) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_smooth</span>(method <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;lm&#34;</span>)
</code></pre></div><p><img src="/example/synthetic-data_files/figure-html/check-risk-malaria-1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Is there a relationship between distance to town hall and net use? Yeah, those who live further away are less likely to use a net.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">ggplot</span>(iv_data, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> distance, fill <span style="color:#f92672">=</span> <span style="color:#a6e22e">as.factor</span>(net))) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_density</span>(alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.7</span>)
</code></pre></div><p><img src="/example/synthetic-data_files/figure-html/check-distance-net-1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Is there a relationship between net use and malaria risk? Haha, yeah, that&rsquo;s a huge highly significant effect. Probably too perfect. We could increase those error bars if we tinker with some of the numbers in the code, but for the sake of this example, we&rsquo;ll leave them like this.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">ggplot</span>(iv_data, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> <span style="color:#a6e22e">as.factor</span>(net), y <span style="color:#f92672">=</span> malaria_risk, color <span style="color:#f92672">=</span> <span style="color:#a6e22e">as.factor</span>(net))) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">stat_summary</span>(geom <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;pointrange&#34;</span>, fun.data <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;mean_se&#34;</span>)
</code></pre></div><p><img src="/example/synthetic-data_files/figure-html/check-net-risk-1.png" width="75%" style="display: block; margin: auto;" /></p>
</li>
<li>
<p><strong>Try it out!</strong></p>
<p>Cool, let&rsquo;s see if this works. Remember, we can&rsquo;t actually use the <code>risk_factors</code> column in real life, but we will here just to make sure the effect we built in exists. Here&rsquo;s the true effect, where using a net causes a decrease of 10.9 malaria risk points</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">model_forbidden <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(malaria_risk <span style="color:#f92672">~</span> net <span style="color:#f92672">+</span> risk_factors, data <span style="color:#f92672">=</span> iv_data)
<span style="color:#a6e22e">tidy</span>(model_forbidden)
<span style="color:#75715e">## # A tibble: 3 x 5</span>
<span style="color:#75715e">##   term         estimate std.error statistic   p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;           &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)    20.6     0.873        23.6 6.98e-106</span>
<span style="color:#75715e">## 2 net           -10.8     0.400       -27.1 3.93e-133</span>
<span style="color:#75715e">## 3 risk_factors    0.283   0.00788      35.9 1.16e-206</span>
</code></pre></div><p>Since we can&rsquo;t actually use that column, we&rsquo;ll use distance to town hall as an instrument. We should run this set of models:</p>
<p>$$
\begin{aligned}
\widehat{\text{Net}} &amp;= \gamma_0 + \gamma_1 \text{Distance to town hall} + \omega \\<br>
\text{Malaria risk} &amp;= \beta_0 + \beta_1 \widehat{\text{Net}} + \epsilon
\end{aligned}
$$</p>
<p>We&rsquo;ll run this 2SLS model with the <code>iv_robust()</code> function from the <strong>estimatr</strong> package:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">library</span>(estimatr)
   
model_iv <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">iv_robust</span>(malaria_risk <span style="color:#f92672">~</span> net <span style="color:#f92672">|</span> distance, data <span style="color:#f92672">=</span> iv_data)
<span style="color:#a6e22e">tidy</span>(model_iv)
<span style="color:#75715e">##          term estimate std.error statistic    p.value conf.low conf.high   df      outcome</span>
<span style="color:#75715e">## 1 (Intercept)   47.202     1.576     29.95 2.344e-156    44.11    50.294 1576 malaria_risk</span>
<span style="color:#75715e">## 2         net   -8.236     2.474     -3.33  8.889e-04   -13.09    -3.385 1576 malaria_risk</span>
</code></pre></div><p>…and it&rsquo;s relatively close, I guess, at −8.2. Getting instrumental variables to find exact causal effects is tricky, but I&rsquo;m fine with this for simulated data.</p>
</li>
<li>
<p><strong>Save the data.</strong></p>
<p>The data works well enough, so we&rsquo;ll get rid of the extra intermediate columns and save it as a CSV file. We&rsquo;ll keep the forbidden <code>risk_factors</code> column just for fun.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">iv_data_final <span style="color:#f92672">&lt;-</span> iv_data <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">select</span>(id, net, distance, malaria_risk, risk_factors)
   
<span style="color:#a6e22e">head</span>(iv_data_final)
<span style="color:#75715e">## # A tibble: 6 x 5</span>
<span style="color:#75715e">##      id   net distance malaria_risk risk_factors</span>
<span style="color:#75715e">##   &lt;int&gt; &lt;int&gt;    &lt;dbl&gt;        &lt;dbl&gt;        &lt;dbl&gt;</span>
<span style="color:#75715e">## 1     1     1     3.98         36.5         69.8</span>
<span style="color:#75715e">## 2     2     1     2.14         49.5        107. </span>
<span style="color:#75715e">## 3     3     0     5.47         56.4        127. </span>
<span style="color:#75715e">## 4     4     0     9.61         20.4         41.4</span>
<span style="color:#75715e">## 5     5     0     4.66         40.9        111. </span>
<span style="color:#75715e">## 6     6     1     2.29         51.3        113.</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Save data</span>
<span style="color:#a6e22e">write_csv</span>(iv_data_final, <span style="color:#e6db74">&#34;data/bed_nets_iv.csv&#34;</span>)
</code></pre></div></li>
</ol>
<h2 id="use-synthetic-data-packages">Use synthetic data packages</h2>
<p>There are several R packages that let you generate synthetic data with built-in relationships in a more automatic way. They all work a little differently, and if you&rsquo;re interested in trying them out, make sure you check the documentation for details.</p>
<h3 id="fabricatr">fabricatr</h3>
<p>The <a href="https://declaredesign.org/r/fabricatr/" target="_blank" rel="noopener"><strong>fabricatr</strong> package</a> is a very powerful package for simulating data. It was invented specifically for using in preregistered studies, so it can handle a ton of different data structures like <a href="https://declaredesign.org/r/fabricatr/articles/cross_classified.html" target="_blank" rel="noopener">panel data</a> and <a href="https://declaredesign.org/r/fabricatr/articles/time_series.html" target="_blank" rel="noopener">time series data</a>. You can build in causal effects and force columns to be correlated with each other.</p>
<p><strong>fabricatr</strong> has exceptionally well-written documentation with like a billion detailed examples (see <a href="https://declaredesign.org/r/fabricatr/" target="_blank" rel="noopener">the right sidebar here</a>). This is a gold standard package and you should most definitely check it out.</p>
<p>Here&rsquo;s a simple example of simulating a bunch of voters and making older ones more likely to vote:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">library</span>(fabricatr)

<span style="color:#a6e22e">set.seed</span>(<span style="color:#ae81ff">1234</span>)

fake_voters <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">fabricate</span>(
  <span style="color:#75715e"># Make 100 people</span>
  N <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>,
  <span style="color:#75715e"># Age uniformly distributed between 18 and 85</span>
  age <span style="color:#f92672">=</span> <span style="color:#a6e22e">round</span>(<span style="color:#a6e22e">runif</span>(N, <span style="color:#ae81ff">18</span>, <span style="color:#ae81ff">85</span>)),
  <span style="color:#75715e"># Older people more likely to vote</span>
  turnout <span style="color:#f92672">=</span> <span style="color:#a6e22e">draw_binary</span>(prob <span style="color:#f92672">=</span> <span style="color:#a6e22e">ifelse</span>(age <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">40</span>, <span style="color:#ae81ff">0.4</span>, <span style="color:#ae81ff">0.7</span>), N <span style="color:#f92672">=</span> N)
)

<span style="color:#a6e22e">head</span>(fake_voters)
<span style="color:#75715e">##    ID age turnout</span>
<span style="color:#75715e">## 1 001  26       0</span>
<span style="color:#75715e">## 2 002  60       1</span>
<span style="color:#75715e">## 3 003  59       1</span>
<span style="color:#75715e">## 4 004  60       1</span>
<span style="color:#75715e">## 5 005  76       1</span>
<span style="color:#75715e">## 6 006  61       1</span>
</code></pre></div><p>And here&rsquo;s an example of country-year panel data where there are country-specific and year-specific effects on GDP:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">set.seed</span>(<span style="color:#ae81ff">1234</span>)

panel_global_data <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">fabricate</span>(
  years <span style="color:#f92672">=</span> <span style="color:#a6e22e">add_level</span>(
    N <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>,
    ts_year <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">9</span>,
    year_shock <span style="color:#f92672">=</span> <span style="color:#a6e22e">rnorm</span>(N, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.3</span>)
  ),
  countries <span style="color:#f92672">=</span> <span style="color:#a6e22e">add_level</span>(
    N <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>,
    base_gdp <span style="color:#f92672">=</span> <span style="color:#a6e22e">runif</span>(N, <span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">22</span>),
    growth_units <span style="color:#f92672">=</span> <span style="color:#a6e22e">runif</span>(N, <span style="color:#ae81ff">0.25</span>, <span style="color:#ae81ff">0.5</span>),
    growth_error <span style="color:#f92672">=</span> <span style="color:#a6e22e">runif</span>(N, <span style="color:#ae81ff">0.15</span>, <span style="color:#ae81ff">0.5</span>),
    nest <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>
  ),
  country_years <span style="color:#f92672">=</span> <span style="color:#a6e22e">cross_levels</span>(
    by <span style="color:#f92672">=</span> <span style="color:#a6e22e">join</span>(years, countries),
    gdp_measure <span style="color:#f92672">=</span> base_gdp <span style="color:#f92672">+</span> year_shock <span style="color:#f92672">+</span> (ts_year <span style="color:#f92672">*</span> growth_units) <span style="color:#f92672">+</span>
      <span style="color:#a6e22e">rnorm</span>(N, sd <span style="color:#f92672">=</span> growth_error)
  )
) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Scale up the years to be actual years instead of 1, 2, 3, etc.</span>
  <span style="color:#a6e22e">mutate</span>(year <span style="color:#f92672">=</span> ts_year <span style="color:#f92672">+</span> <span style="color:#ae81ff">2010</span>)

<span style="color:#a6e22e">head</span>(panel_global_data)
<span style="color:#75715e">##   years ts_year year_shock countries base_gdp growth_units growth_error country_years gdp_measure year</span>
<span style="color:#75715e">## 1    01       0   -0.36212         1    17.22       0.4526       0.3096            01       17.07 2010</span>
<span style="color:#75715e">## 2    02       1    0.08323         1    17.22       0.4526       0.3096            02       17.55 2011</span>
<span style="color:#75715e">## 3    03       2    0.32533         1    17.22       0.4526       0.3096            03       18.72 2012</span>
<span style="color:#75715e">## 4    04       3   -0.70371         1    17.22       0.4526       0.3096            04       17.99 2013</span>
<span style="color:#75715e">## 5    05       4    0.12874         1    17.22       0.4526       0.3096            05       19.25 2014</span>
<span style="color:#75715e">## 6    06       5    0.15182         1    17.22       0.4526       0.3096            06       19.63 2015</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">ggplot</span>(panel_global_data, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> year, y <span style="color:#f92672">=</span> gdp_measure, color <span style="color:#f92672">=</span> countries)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_line</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Year&#34;</span>, y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Log GDP&#34;</span>, color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Countries&#34;</span>)
</code></pre></div><p><img src="/example/synthetic-data_files/figure-html/fake-panel-data-1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>That all just scratches the surface of what <strong>fabricatr</strong> can do. Again, check the examples and documentation and play around with it to see what else it can do.</p>
<h3 id="wakefield">wakefield</h3>
<p>The <a href="https://github.com/trinker/wakefield" target="_blank" rel="noopener"><strong>wakefield</strong> package</a> is jokingly named after <a href="https://en.wikipedia.org/wiki/Andrew_Wakefield" target="_blank" rel="noopener">Andrew Wakefield</a>, the British researcher who invented fake data to show that the MMR vaccine causes autism. This package lets you quickly generate random fake datasets. It has a bunch of pre-set column possibilities, like age, color, Likert scales, political parties, religion, and so on, and you can also use standard R functions like <code>rnorm()</code>, <code>rbinom()</code>, or <code>rbeta()</code>. It also lets you create repeated measures (1st grade score, 2nd grade score, 3rd grade score, etc.) and build correlations between variables.</p>
<p>You should <em>definitely</em> <a href="https://github.com/trinker/wakefield" target="_blank" rel="noopener">look at the documentation</a> to see a ton of examples of how it all works. Here&rsquo;s a basic example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">library</span>(wakefield)

<span style="color:#a6e22e">set.seed</span>(<span style="color:#ae81ff">1234</span>)

wakefield_data <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">r_data_frame</span>(
  n <span style="color:#f92672">=</span> <span style="color:#ae81ff">500</span>,
  id,
  treatment <span style="color:#f92672">=</span> <span style="color:#a6e22e">rbinom</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0.3</span>),  <span style="color:#75715e"># 30% chance of being in treatment</span>
  outcome <span style="color:#f92672">=</span> <span style="color:#a6e22e">rnorm</span>(mean <span style="color:#f92672">=</span> <span style="color:#ae81ff">500</span>, sd <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>),
  race,
  age <span style="color:#f92672">=</span> <span style="color:#a6e22e">age</span>(x <span style="color:#f92672">=</span> <span style="color:#ae81ff">18</span><span style="color:#f92672">:</span><span style="color:#ae81ff">45</span>),
  sex <span style="color:#f92672">=</span> <span style="color:#a6e22e">sex_inclusive</span>(),
  survey_question_1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">likert</span>(),
  survey_question_2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">likert</span>()
)
<span style="color:#a6e22e">head</span>(wakefield_data)
<span style="color:#75715e">## # A tibble: 6 x 8</span>
<span style="color:#75715e">##   ID    treatment outcome Race       age sex      survey_question_1 survey_question_2</span>
<span style="color:#75715e">##   &lt;chr&gt;     &lt;int&gt;   &lt;dbl&gt; &lt;fct&gt;    &lt;int&gt; &lt;fct&gt;    &lt;ord&gt;             &lt;ord&gt;            </span>
<span style="color:#75715e">## 1 001           0    544. White       35 Intersex Disagree          Agree            </span>
<span style="color:#75715e">## 2 002           0    606. White       38 Male     Disagree          Strongly Disagree</span>
<span style="color:#75715e">## 3 003           0    545. White       38 Female   Neutral           Strongly Agree   </span>
<span style="color:#75715e">## 4 004           0    566. Black       45 Female   Strongly Agree    Disagree         </span>
<span style="color:#75715e">## 5 005           1    386. Black       41 Male     Disagree          Agree            </span>
<span style="color:#75715e">## 6 006           0    463. Hispanic    20 Female   Disagree          Agree</span>
</code></pre></div><h3 id="faux">faux</h3>
<p>The <a href="https://debruine.github.io/faux/" target="_blank" rel="noopener"><strong>faux</strong> package</a> does some really neat things. We can create data that has built-in correlations without going through all the math. For instance, let&rsquo;s say we have 3 variables A, B, and C that are normally distributed with these parameters:</p>
<ul>
<li><strong>A</strong>: mean = 10, sd = 2</li>
<li><strong>B</strong>: mean = 5, sd = 1</li>
<li><strong>C</strong>: mean = 20, sd = 5</li>
</ul>
<p>We want A to correlate with B at r = 0.8 (highly correlated), A to correlate with C at r = 0.3 (less correlated), and B to correlate with C at r = 0.4 (moderately correlated). Here&rsquo;s how to create that data with <strong>faux</strong>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">library</span>(faux)

<span style="color:#a6e22e">set.seed</span>(<span style="color:#ae81ff">1234</span>)

faux_data <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">rnorm_multi</span>(n <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>,
                         mu <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">20</span>),
                         sd <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">5</span>),
                         r <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0.8</span>, <span style="color:#ae81ff">0.3</span>, <span style="color:#ae81ff">0.4</span>),
                         varnames <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;A&#34;</span>, <span style="color:#e6db74">&#34;B&#34;</span>, <span style="color:#e6db74">&#34;C&#34;</span>),
                         empirical <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>)
<span style="color:#a6e22e">head</span>(faux_data)
<span style="color:#75715e">##        A     B     C</span>
<span style="color:#75715e">## 1 11.742 5.612 25.89</span>
<span style="color:#75715e">## 2  9.060 4.177 18.79</span>
<span style="color:#75715e">## 3  9.373 4.466 14.57</span>
<span style="color:#75715e">## 4 10.913 5.341 31.88</span>
<span style="color:#75715e">## 5  8.221 4.039 18.14</span>
<span style="color:#75715e">## 6 10.095 4.517 17.43</span>

<span style="color:#75715e"># Check averages and standard deviations</span>
faux_data <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Convert to long/tidy so we can group and summarize</span>
  <span style="color:#a6e22e">pivot_longer</span>(cols <span style="color:#f92672">=</span> <span style="color:#a6e22e">everything</span>(), names_to <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;variable&#34;</span>, values_to <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;value&#34;</span>) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">group_by</span>(variable) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">summarize</span>(mean <span style="color:#f92672">=</span> <span style="color:#a6e22e">mean</span>(value),
            sd <span style="color:#f92672">=</span> <span style="color:#a6e22e">sd</span>(value))
<span style="color:#75715e">## # A tibble: 3 x 3</span>
<span style="color:#75715e">##   variable  mean    sd</span>
<span style="color:#75715e">##   &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 A        10.2   2.08</span>
<span style="color:#75715e">## 2 B         5.02  1.00</span>
<span style="color:#75715e">## 3 C        20.8   5.01</span>

<span style="color:#75715e"># Check correlations</span>
<span style="color:#a6e22e">cor</span>(faux_data<span style="color:#f92672">$</span>A, faux_data<span style="color:#f92672">$</span>B)
<span style="color:#75715e">## [1] 0.808</span>
<span style="color:#a6e22e">cor</span>(faux_data<span style="color:#f92672">$</span>A, faux_data<span style="color:#f92672">$</span>C)
<span style="color:#75715e">## [1] 0.301</span>
<span style="color:#a6e22e">cor</span>(faux_data<span style="color:#f92672">$</span>B, faux_data<span style="color:#f92672">$</span>C)
<span style="color:#75715e">## [1] 0.4598</span>
</code></pre></div><p><strong>faux</strong> can do a ton of other things too, so make sure you check out <a href="https://debruine.github.io/faux/" target="_blank" rel="noopener">the documentation and all the articles with examples here</a>.</p>

                    </div>

                    



                    
                    <div class="article-widget">
                        
<div class="post-nav">
  
  
  
  <div class="post-nav-item">
    <div class="meta-nav">Previous</div>
    <a href="/example/random-numbers/" rel="next">Generating random numbers</a>
  </div>
  
  
  
  <div class="post-nav-item">
    <div class="meta-nav">Next</div>
    <a href="/example/rdd-fuzzy/" rel="prev">Fuzzy regression discontinuity</a>
  </div>
  
</div>

                    </div>
                    
                </div>

                <div class="body-footer">
                    <p>Last updated on October 31, 2020</p>

                    





                    



                </div>

            </article>

            <footer>
    <hr>

    <div class="row course-info">
        <div class="col-md-7">
            <p>
                <strong>2255: Análisis Estadístico en R (II° Semestre- 2021)</strong><br>

                <a href="https://www.uahurtado.cl/" target="_blank" rel="noopener">Universidad Alberto Hurtado</a> &emsp;&emsp;
                <a href="http://sociologia.uahurtado.cl/" target="_blank" rel="noopener">Departamento de Sociología</a>
            </p>

            <p>
                <a href="https://valentinaandrade.netlify.app/" target="_blank" rel="noopener"><i class="fas fa-user"></i>
                    Valentina Andrade</a> &emsp;&emsp;
                <a href="mailto:valentinaandrade@uchile.cl"><i class="fas fa-envelope"></i>
                    valentinaandrade@uchile.cl</a>
            </p>

            <p>
                <i class="far fa-calendar-alt"></i> Clases: Lunes 16.30-17.40 &emsp;&emsp;
                <i class="fas fa-pencil-alt"></i> Práctico: Lunes 18.00-19.20 
                <br><i class="fas fa-university"></i> Online, en link de Zoom
            </p>
        </div>

        <div class="col-md-5 credits">
            <p>All content licensed under a <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" rel="noopener">Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License</a>.</p>
            
            <p>Content <i class="fab fa-creative-commons"></i> 2021. Web developed by Andrew Heiss and custom by <a href="https://valentinaandrade.netlify.app/" target="_blank" rel="noopener">Valentina Andrade</a></p>
        
            <p>This site created with the <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> in <a href="https://bookdown.org/yihui/blogdown/" target="_blank" rel="noopener">blogdown</a> and <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a>. </p>
            
            <p><a href="https://github.com/valentinaandrade" target="_blank" rel="noopener"><i class="fab fa-github"></i> View the source at GitHub.</a></p>
        </div>
    </div>
</footer>


        </main>
    </div>
</div>

        

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/instant.page/5.1.0/instantpage.min.js" integrity="sha512-1+qUtKoh9XZW7j+6LhRMAyOrgSQKenQ4mluTR+cvxXjP1Z54RxZuzstR/H9kgPXQsVB8IW7DMDFUJpzLjvhGSQ==" crossorigin="anonymous"></script>

      
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      

      
      

      

      

    

    
    
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.2/anchor.min.js" integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin="anonymous"></script>
    <script>
      anchors.add();
    </script>
    

    
    
    

    
    

    
    
    
    

    
    <script src="/js/bootstrap.bundle.min.8b7df62fd2da18ce73e29c13cc0a6198.js"></script>

    
    

    
    
    
    
    
    
    
    
    
    <script src="/en/js/wowchemy.min.c6ceb5c48772e46156651a48070d6139.js"></script>

    

<script src="/js/math-code.js"></script>


    
    

    
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>

</html>
